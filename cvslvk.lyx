#This file was created by <nikita> Fri Dec 24 17:37:25 1999
#LyX 0.12 (C) 1995-1998 Matthias Ettrich and the LyX Team
\lyxformat 2.15
\textclass article
\begin_preamble
\usepackage[koi8-r]{inputenc}
\usepackage[russian]{babel}
\sloppy
\end_preamble
\language default
\inputencoding default
\fontscheme default
\graphics default
\float_placement ht
\paperfontsize default
\spacing single 
\papersize Default
\paperpackage widemarginsa4
\use_geometry 0
\use_amsmath 0
\paperorientation portrait
\secnumdepth 3
\tocdepth 3
\paragraph_separation skip
\defskip medskip
\quotes_language english
\quotes_times 2
\papercolumns 1
\papersides 1
\paperpagestyle default

\layout Standard
\line_top \line_bottom \align center 

\size huge 
Система cvslvk
\size default 

\newline 

\emph on 
последнее изменение в этот документ внесено 24.12.1999
\newline 

\newline 

\layout Standard


\begin_inset LatexCommand \tableofcontents

\end_inset 


\layout Section

Обзор возможностей системы
\layout Standard

Система cvslvk предназначена для автоматизации процесса сборки программ
 в процессе их разработки и отладки.
 
\layout Standard

Целью разработки системы было максимальное упрощение действий пользователя
 по сборке программ в среде UNIX и снижение вероятности ошибок сборки, не
 диагностируемых стандартными средствами сборки.
 Вместе с системой управления версиями CVS система cvslvk позволяет избежать
 большинства стандартных проблем, возникающих при совместной разработке
 нескольких взаимозависимых модулей несколькими разработчиками в сети, в
 состав которой входят машины с различной архитектурой и различными версиями
 ОС UNIX.
\begin_float footnote 
\layout Standard

В данный момент поддерживаются архитектуры sparc и x86 и операционные системы
 Linux и Solaris
\end_float 
\layout Standard

Ниже перечисляются основные возможности системы cvslvk.
\layout Itemize

В большинстве случаев для сборки исполняемого модуля достаточно просто указать
 его имя и перечислить файлы исходных текстов.
 Размер пользовательского 
\family typewriter 
Makefile
\family default 
-а составляет при этом всего 3 строки.
\layout Itemize

Система обеспечивает автоматическое отслеживание зависимостей файлов между
 собой и пересборку тех и только тех из них, которые нуждаются в пересборке.
 Команда 
\family typewriter 
make
\family default 
 всегда создаст корректный исполняемый файл, вне зависимости от состояния
 рабочего каталога перед ее выполнением, причем сделает это в минимально
 возможное время.
\layout Itemize

Система пытается скрыть различия между архитектурами и компиляторами, оставляя
 тем не менее возможность индивидуальной настройки под конкретные комбинации.
\layout Itemize

Система позволяет одной командой полностью собирать модуль с различными
 параметрами сборки, в т.ч.
 для отладки или с оптимизациями; различными компиляторами; различными режимами
 использования разделяемых библиотек; любыми пользовательскими параметрами.
 Смешивание объектных файлов с различными параметрами сборки исключено.
 Возможно параллельно работать с несколькими сборками, не осуществляя полных
 перетрансляций при переходе между ними.
\layout Itemize

Система предоставляет простой (сводящийся к установке единственной переменной
 в 
\family typewriter 
Makefile
\family default 
-ах) механизм контроля необходимых переменных среды.
 Если корректная работа модуля зависит от переменных среды, работа продолжится
 только после корректной их установки.
\layout Itemize

Система обеспечивает прозрачный механизм создания и использования динамических
 библиотек.
 По умолчанию все создаваемые библиотеки динамические.
 Обеспечивается их корректный поиск и динамическая линковка без каких-либо
 дополнительных установок пользователя.
\newline 
Кроме того, в систему встроены средства контроля порядка подсоединения библиотек
 при сборке исполняемого файла, что бывает полезно при использовании некоторых
 приемов программирования.
\layout Itemize

Система обеспечивает мощный механизм управления зависимостями между модулями.
 Для использования внешнего модуля достаточно только указать его имя.
 Система автоматически выберет нужную версию каждого из используемых модулей
 и корректно ее подключит: автоматически осуществит пересборку при изменениях
 в используемых модулях.
\begin_deeper 
\layout Standard

Свойства каждого модуля описываются при помощи привязанного к нему включаемого
 
\family typewriter 
Makefile
\family default 
-а, синтаксис которого предоставляет очень широкие возможности по определению
 семантики модуля.
 В результате внешним модулем может быть библиотека, средство генерации
 исходных текстов по грамматике, вся среда DYANA и т.д., причем прозрачно
 для пользователя.
\end_deeper 
\layout Itemize

Вся система представляет из себя несколько текстовых файлов, которые при
 необходимости легко модифицируются и подстраиваются под нужды конкретного
 проекта.
\layout Standard

В принципе, система позволяет работу с ней неподготовленного пользователя.
 Однако, как и везде в системе UNIX, для наиболее полного использования
 всех предоставляемых возможностей пользователю необходимы знания.
 В частности, пользователю следует хорошо понимать, из каких этапов состоит
 сборка исполняемого файла из исходных текстов и какие преобразования файлов
 при этом имеют место.
 Также следует представлять алгоритм работу утилиты make и синтаксис 
\family typewriter 
Makefile
\family default 
-ов.
\begin_float footnote 
\layout Standard

Если пользователь хочет автоматизировать более сложные процессы, для которых
 стандартный синтаксис 
\family typewriter 
Makefile
\family default 
-а недостаточен, то следует изучить расширенный синтаксис GNU make, который
 и был использован для написания системы CVSLVK
\end_float 
 
\layout Section

Требования
\layout Standard

Система cvslvk имеет следующие требования:
\layout Enumerate

Система cvslvk работает ТОЛЬКО с 
\family typewriter 
GNU make
\family default 
.
 Sun-овский 
\family typewriter 
make
\family default 
 работать НЕ БУДЕТ.
\newline 
На серверах 
\family typewriter 
redsun
\family default 
, 
\family typewriter 
chronos
\family default 
 и 
\family typewriter 
tornado
\family default 
 для обеспечения работоспособности системы следует поставить 
\family typewriter 
/usr/local/bin
\family default 
 в 
\family typewriter 
$PATH
\family default 
 на первое место.
\layout Enumerate

Переменная среды 
\family typewriter 
CL_DIR
\family default 
 должна указывать на каталог системы.
\newline 
На серверах 
\family typewriter 
redsun
\family default 
, 
\family typewriter 
chronos
\family default 
, 
\family typewriter 
snuppy 
\family default 
и 
\family typewriter 
tornado
\family default 
 каталогом системы является 
\family typewriter 
/usr/local/builds
\family default 
.
\begin_float footnote 
\layout Standard

Возможна также инсталляция системы в домашние каталоги пользователей, при
 этом там могут быть как файлы системы, так и символьные ссылки на эти файлы
 в 
\family typewriter 
/usr/local/builds
\family default 
.
\end_float 
 
\layout Section

Простейшее использование
\layout Standard

Пусть пользовательская программа 
\family typewriter 
myprogram
\family default 
 собирается из файлов 
\family typewriter 
main.c
\family default 
, 
\family typewriter 
lib.c
\family default 
, 
\family typewriter 
global.h
\family default 
 и 
\family typewriter 
lib.h
\family default 
.
 При этом файл 
\family typewriter 
global.h
\family default 
 включается в оба Си-файла, а файл 
\family typewriter 
lib.h
\family default 
 -- только в файл 
\family typewriter 
lib.c
\family default 
.
 В этом случае 
\family typewriter 
Makefile
\family default 
 будет иметь следующий вид:
\layout LyX-Code

EXECUTABLE = myprogram
\layout LyX-Code

SOURCES = main.c lib.c
\layout LyX-Code

include $(CL_DIR)/Makefile.cvslvk
\layout Standard

При этом:
\layout Itemize

По команде 
\family typewriter 
make
\family default 
 будет создан исполняемый файл без оптимизаций и с отладочной информацией,
 при помощи компилятора gcc.
 Т.е.
 будет подготовлено все для отладки программы отладчиком gdb или ddd.
\layout Itemize

При изменении файла 
\family typewriter 
main.c
\family default 
 и повторного вызова 
\family typewriter 
make
\family default 
 будет перетранслирован только файл 
\family typewriter 
main.c
\family default 
.
 При изменении файла 
\family typewriter 
lib.c
\family default 
 или 
\family typewriter 
lib.h
\family default 
 будет перетранслирован файл 
\family typewriter 
lib.c
\family default 
.
 При изменении файла 
\family typewriter 
global.h
\family default 
 будут перетранслированы оба Си-файла.
 Легко видеть, что именно такие перетрансляции необходимы в данном случае.
 Однако, явно они нигде не указывались.
 Зависимости в системе cvslvk вычисляются автоматически.
\layout Itemize

По команде 
\family typewriter 
make clean
\family default 
 будут удалены все файлы, созданные в процессе сборки.
\layout Itemize

По команде 
\family typewriter 
make
\protected_separator 
CL_OPTIMIZE=1
\family default 
 будет осуществлена компиляция с оптимизацией.
 При этом объектные файлы с отладочной информацией, созданные ранее, удалены
 не будут.
 Соответственно, в дальнейшем при продолжении отладки не придется все перетрансл
ировать.
\layout Itemize

По команде 
\family typewriter 
make
\protected_separator 
CL_COMP=suncc
\family default 
 будет осуществлена компиляция при помощи компилятора фирмы Sun, с отладочной
 информацией.
 По команде 
\family typewriter 
make
\protected_separator 
CL_COMP=suncc
\protected_separator 
СL_OPTIMIZE=1
\family default 
 будет осуществлена компиляция при помощи компилятора фирмы Sun, с оптимизацией.
\layout Standard

Все файлы, созданные в процессе сборки, будут помещены в подкаталог.
 Будем называть этот подкаталог 
\emph on 
подкаталогом сборки
\emph toggle 
.
 Имя подкаталога сборки составляется из имени архитектуры, названия операционной
 системы и параметров сборки (предопределенных и определяемых пользователем).
 Так, если осуществлять сборку рассматриваемого примера на сервере 
\family typewriter 
redsun
\family default 
, то подкаталог сборки будет назван 
\family typewriter 
sparc-solaris-debug/
\family default 
.
 При сборки этого же примера с оптимизацией подкаталог сборки будет назван
 
\family typewriter 
sparc-solaris-optimized/
\family default 
.
\layout Standard

Собранный исполняемый файл создается в подкаталоге сборки, а в основной
 каталог помещается символьная ссылка на исполняемый файл.
\layout Standard

Команда 
\family typewriter 
make
\protected_separator 
clean
\family default 
 удаляет каталог сборки и указывающие на него символические ссылки.
 В данном примере будет удален каталог 
\family typewriter 
sparc-solaris-debug/
\family default 
, а каталог 
\family typewriter 
sparc-solaris-optimized/
\family default 
 останется.
 Для удаления каталога 
\family typewriter 
sparc-solaris-optimized/
\family default 
 следует ввести команду 
\begin_inset Quotes eld
\end_inset 


\family typewriter 
make
\protected_separator 
clean
\protected_separator 
CL_OPTIMIZE=1
\family default 

\begin_inset Quotes erd
\end_inset 

.
\layout Standard

Команда 
\family typewriter 
make
\protected_separator 
cleanall
\family default 
 удалит все созданные каталоги сборки.
\layout Section

Пользовательский справочник
\layout Standard

В данном разделе дается полное описание 
\emph on 
интерфейса
\emph toggle 
 системы cvslvk.
 Под интерфейом понимается набор команд и параметров, используемых при работе
 с системой.
 
\layout Subsection

Расположение файлов
\layout Standard

Система cvslvk накладывает определенные требования на расположение файлов
 пользователя.
\begin_float footnote 
\layout Standard

Возможно, со временем эти требования будут ослаблены.
 Сейчас их при необходимости можно обеспечить при помощи символических ссылок.
\end_float 
\layout Standard

Базовым понятием системы является 
\emph on 
рабочий каталог
\emph toggle 
.
 В одном рабочем каталоги располагаются файлы, из которых собирается одна
 программа или одна библиотека.
 Также в рабочем каталоге должен быть файл с именем 
\family typewriter 
Makefile
\family default 
 или 
\family typewriter 
makefile
\family default 
, содержащий инструкции по сборке.
 Называть этот файл по-другому и пользоваться ключем 
\family typewriter 
-f
\family default 
 программы 
\family typewriter 
make
\family default 
 в текущей версии системы не рекомендуется.
\layout Standard

При сборке проекта в рабочем каталоге создается 
\emph on 
каталог сборки
\emph toggle 
, в который помещаются все создаваемые файлы.
 К создаваемым файлам относятся файлы с описанием зависимостей (
\family typewriter 
*.deps
\family default 
), объектные файлы, создаваемый исполняемый файл или библиотека, служебные
 файлы системы cvslvk, и файлы, создаваемые используемыми модулями
\begin_float footnote 
\layout Standard

Например, модуль -- средство создания парсера по грамматике поместит в каталог
 сборки созданный код на языке Си или Си++.
\end_float 
.
\layout Standard

Имя каталога сборки представляет из себя резделенные символом 
\begin_inset Quotes eld
\end_inset 


\family typewriter 
-
\family default 

\begin_inset Quotes erd
\end_inset 

 параметры сборки.
 К параметрам относятся архитектура и операционная система машины, для которой
 осуществлялась сборка, отладочная это сборка или оптимизированная, возможно
 компилятор, возможно тип библиотеки (статическая или разделяемая), возможны
 любые пользовательские параметры.
 
\layout Standard

При изменении параметров сборки создаваемые файлы будут помещены в новый
 каталог сборки.
 Одновременно в рабочем каталоге может быть несколько каталогов сборки.
 Это позволяет избежать лишних перетрансляций при переходе от одних параметров
 сборки к другим и обратно.
\layout Standard

В рабочем каталоге могут быть также подкаталоги c той же структурой, что
 и сам рабочий каталог.
 В таком подкаталоге будут находиться все исходные файлы некоторой другой
 программы или библиотеки.
 Например, если некоторый проект представляет из себя библиотеку и тестирующую
 программу, то в основном каталоге проекта будут файлы, из которых собирается
 библиотека, а в подкаталоге -- тестирующая программа.
\layout Standard

В рабочем каталоге может не быть ничего кроме таких подкаталогов (и состоящего
 из двух строк 
\family typewriter 
Makefile
\family default 
-а, указывающего, что сборка этого каталога сводится к сборке подкаталогов).
 Такая структура предназначена для ситуации, когда проект состоит из нескольких
 программ.
\layout Subsection

Основная операция -- сборка каталога
\layout Standard

Основной операцией системы cvslvk является 
\emph on 
сборка каталога
\emph toggle 
.
 
\layout Standard

Действия, выполняемые по этой операции, формально совпадают с действиями
 стандартной утилиты 
\family typewriter 
make
\family default 
.
 А именно, определяется последовательность операций, которую необходимо
 выполнить для обновления 
\emph on 
цели
\emph toggle 
 (в данном случае -- программы или библиотеки, собираемой в данном каталоге),
 после чего эта последовательность выполняется.
\layout Standard

Отличие от стандартной утилиты 
\family typewriter 
make
\family default 
 заключается в уровне входного языка.
 Система cvslvk является надстройкой над 
\family typewriter 
make
\family default 
, которая скрывает технические детали стандартных операций.
 Можно рассматривать ее как развитие идеи неявных правил 
\family typewriter 
make
\family default 
.
\layout Standard

Сборка каталога вызывается командой 
\family typewriter 
make
\family default 
.
 Параметрами команды 
\family typewriter 
make
\family default 
 могут быть параметры сборки.
 Они задаются как переменные 
\family typewriter 
make
\family default 
: 
\family typewriter 
<имя>=<значение>
\family default 
.
\begin_float footnote 
\layout Standard

Параметры сборки также могут быть переданы через переменные окружения.
\end_float 
 Например, команда 
\family typewriter 
make
\protected_separator 
CL_OPTIMIZE=1
\family default 
 запустит сборку с оптимизацией.
\layout Standard

При сборке каталога выполняются, как минимум, следующие действия:
\layout Itemize

пересчитываются зависимости для всех файлов, для которых они могли измениться,
\layout Itemize

перетранслируются файлы,
\layout Itemize

пересобирается цель.
\layout Subsection

Параметры сборки каталога
\layout Standard

Сборка каталога управляется набором параметров.
 Параметры могут быть заданы в командной строке, в 
\family typewriter 
Makefile
\family default 
-е, в переменных окружения.
 Параметры, заданные в командной строке, имеют больший приоритет, чем заданные
 в 
\family typewriter 
Makefile
\family default 
-е, а заданные в 
\family typewriter 
Makefile
\family default 
-е -- больший приоритет, чем заданные в переменных окружения.
 Однако, синтаксис 
\family typewriter 
Makefile
\family default 
-а позволяет определять в нем параметры, которые нельзя будет перегрузить
 из командной строки.
 Параметры, существенные для сборки, рекомендуется определять именно таким
 образом.
\layout Subsubsection

Что и из чего собирать
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
SOURCES
\family default 
\series default 

\newline 
В этой переменной перечисляется список исходных файлов, расположенных в
 рабочем каталоге.
 В этом списке могут быть перемешаны файлы на языках Си, Си++ и mm-языке
\begin_float footnote 
\layout Standard

Последнее -- при использовании соответствующих модулей (см.
 раздел 
\begin_inset LatexCommand \ref{sec: modules}

\end_inset 

)
\end_float 
.
 Файлы на языке Си должны иметь имена, заканчивающиеся на 
\family typewriter 
.c
\family default 
, файлы на языке Си++ -- имена, заканчивающиеся на 
\family typewriter 
.cpp
\family default 
, 
\family typewriter 
.cc
\family default 
 или 
\family typewriter 
.C
\family default 
, файлы на mm-языке -- имена, заканчивающиеся на 
\family typewriter 
.mm
\family default 
.
 Для каждого типа файлов будет автоматически выбран соответствующий компилятор.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
EXECUTABLE
\family default 
\series default 

\newline 
Переключает систему cvslvk в режим сборки исполняемого файла, и задает имя
 исполняемого файла.
\begin_deeper 
\layout Standard

Кроме режима сборки исполняемого файла, в системе cvslvk имеется режим сборки
 библиотеки, описанный ниже.
\end_deeper 
\layout Standard

В простейшем случае ничего, кроме определения этих двух переменных, не требуется.
 Остальные переменные предназначены для тонкого управления сборкой или для
 подключения дополнительных возможностей системы cvslvk.
\layout Subsubsection

Выбор компилятора
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_COMP
\family default 
\series default 

\newline 
Возможные значения: 
\family typewriter 
gcc
\family default 
, 
\family typewriter 
suncc
\begin_deeper 
\layout Standard

Если эта переменная не определена, то используемый компилятор определяется
 требованиями используемых модулей.
 Если используемые модули не предъявляют однозначных требований (или никакие
 модули не используются), то будет использован компилятор 
\family typewriter 
gcc
\family default 
.
\layout Standard

Если эта переменная определена, то будет использован именно указанный компилятор.
 Если используемые модули не совместимы с ним, то сборка будет аварийно
 завершена.
\layout Standard

В случае, когда файлы, находящиеся в данном каталоге, могут быть собраны
 только конкретным компилятором, переменную 
\family typewriter 
CL_COMP
\family default 
 рекомендуется задавать в 
\family typewriter 
Makefile
\family default 
-е.
 Во всех остальных случаях рекомендуется задавать эту переменную из командной
 строки или не задавать вообще (в большинстве случаев система cvslvk обеспечит
 выбор правильного компилятора).
\end_deeper 
\layout Subsubsection

Отладка ИЛИ оптимизация
\layout Standard

Если программа
\begin_float footnote 
\layout Standard

Здесь и далее -- строго говоря, программа или библиотека
\end_float 
 собирается с целью ее 
\emph on 
отладки
\emph toggle 
, то ее следует собирать 
\emph on 
с отладочной информацией
\emph toggle 
 -- дополнительных данных, которые позволят отладчику работать с именами
 переменных, строками исходных текстов программы и т.п., а не с числовыми
 адресами.
\layout Standard

Если программа собирается с целью ее 
\emph on 
использования
\emph toggle 
, то ее следует собирать 
\emph on 
с оптимизацией
\emph toggle 
 -- при этом значительно увеличится скорость ее работы.
\layout Standard


\emph on 
Стандартной ошибкой
\emph toggle 
 является сборка программы с отладочной информацией И с оптимизацией.
 Так делать 
\emph on 
не следует
\emph toggle 
.
 Программу, собранную с оптимизацией, отлаживать неудобно.
 Например, из-за имеющих место при оптимизации перестановок кода такое стандартн
ое действие отладчика, как выполнить одну строку программы, становится невозможн
ым (на практике оно приводит к загадочным прыжкам точки выполнения вверх-вниз
 по телу программы).
 Если же в данный момент программу отлаживать не предполагается, то отладочная
 информация только резко увеличит размер исполняемого файла и замедлит его
 старт.
\layout Standard

Система cvslvk строго разделяет сборки с отладочной информацией и с оптимизацией.
 По умолчанию осуществляется сборка с отладочной информацией и без оптимизации,
 т.е.
 программа подготавливается к отладке.
 Другой вариант сборки -- с оптимизацией и без отладочной информации --
 включается при помощи параметров сборки.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_OPTIMIZE
\begin_deeper 
\layout Standard

Если эта переменная определена, то включается режим сборки с оптимизацией
 (и без отладочной информации).
 Рекомендуется использовать эту переменную только в командной строке 
\family typewriter 
make
\family default 
.
\end_deeper 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_NDEBUG
\begin_deeper 
\layout Standard

Если эта переменная определена, и не определена переменная
\series bold 
 
\family typewriter 
\series default 
CL_OPTIMIZE
\family default 
, то включается режим сборки без отладочной информации и без оптимизации.
 
\emph on 
Этот режим 
\begin_inset Quotes eld
\end_inset 

на крайний случай
\begin_inset Quotes erd
\end_inset 

 -- его следует использовать вместо 
\family typewriter 
CL_OPTIMIZE
\family default 
 только если последний по какой-либо причине не работает (например, из-за
 ошибки в компиляторе).
\end_deeper 
\layout Standard

Для включения отладочной информации или оптимизации компиляторам необходимо
 передать некоторые ключи командной строки.
 И отладочная информация, и оптимизация бывают разными (и соответственно
 могут включаться разными ключами).
 В большинстве случаев можно использовать режимы, принятые по умолчанию,
 однако иногда могут понадобиться и другие -- тогда следует определить в
 
\family typewriter 
Makefile
\family default 
-е одну или несколько из слудующих переменных.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_GCC_DEBUG
\newline 

\family default 
\series default 
Значение по умолчанию: 
\family typewriter 
-g
\newline 

\family default 
Указывает флаги, передаваемые компиляторам 
\family typewriter 
gcc
\family default 
 и 
\family typewriter 
g++
\family default 
, для сборки с отладочной информацией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_SUNCC_DEBUG
\newline 

\family default 
\series default 
Значение по умолчанию: 
\family typewriter 
-g
\newline 

\family default 
Указывает флаги, передаваемые компиляторам фирмы Sun, для сборки с отладочной
 информацией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_GCC_OPTIMIZE
\newline 

\family default 
\series default 
Значение по умолчанию: 
\family typewriter 
-O2
\newline 

\family default 
Указывает флаги, передаваемые компиляторам 
\family typewriter 
gcc
\family default 
 и 
\family typewriter 
g++
\family default 
, для сборки с оптимизацией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_SUNCC_OPTIMIZE
\newline 

\family default 
\series default 
Значение по умолчанию: 
\family typewriter 
-O2
\newline 

\family default 
Указывает флаги, передаваемые компиляторам фирмы Sun, для сборки с оптимизацией.
\layout Standard

Значения переменных 
\family typewriter 
CL_GCC_DEBUG
\family default 
 и 
\family typewriter 
CL_GCC_OPTIMIZE
\family default 
 будут автоматически использованы когда используется компиляторы GNU, значения
 переменных 
\family typewriter 
CL_SUNCC_DEBUG
\family default 
 и 
\family typewriter 
CL_SUNCC_OPTIMIZE
\family default 
 -- когда используются компиляторы Sun.
\layout Subsubsection

Стандартные флаги компилятора -- 
\family typewriter 
DEFINES
\family default 
 и 
\family typewriter 
INCLUDES
\layout Standard

Часто используемыми флагами Си- и Си++-компиляторов являются макросы препроцессо
ра, определяемые в командной строке (флаг
\protected_separator 

\family typewriter 
-D
\family default 
) и пути для поиска файлов, включаемых директивой препроцессора 
\family typewriter 
#inсlude
\family default 
 (флаг
\protected_separator 

\family typewriter 
-I
\family default 
).
\layout Standard

В системе cvslvk эти флаги заносятся в соответствующие переменные, описанные
 ниже.
 Формат совпадает с форматом командной строки компиляторов, например: 
\family typewriter 
-I/usr/local/package/include
\family default 
, 
\family typewriter 
-DXXX
\family default 
, 
\family typewriter 
-DYYY=yyy
\family default 
.
\begin_float footnote 
\layout Standard

На самом деле, описанное ниже разбиение флагов по переменным -- не более
 чем соглашение, для удобства.
 В принципе, никто не мешает ставить, например, флаги 
\family typewriter 
-I
\family default 
 в переменную 
\family typewriter 
DEFINES
\family default 
 или 
\family typewriter 
-D
\family default 
 в переменную 
\family typewriter 
CL_GCC_DEBUG
\family default 
.
\end_float 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
INCLUDES
\newline 

\family default 
\series default 
Предназначена для флагов 
\family typewriter 
-I
\family default 
, указывающих пути для поиска include-файлов.
 
\newline 
Следует иметь в виду, что если include-файлы относятся к используемым модулям,
 то явно устанавливать путь к ним в этой переменной не надо -- это будет
 сделано автоматически при подключении модуля.
 На практике, переменную 
\family typewriter 
INCLUDES
\family default 
 надо устанавливать только когда используемся что-то внешнее по отношению
 к системе cvslvk
\begin_float footnote 
\layout Standard

т.е.
 не оформленное в виде ее модуля или псевдомодуля.
 Подробнее см.
 ниже
\end_float 
.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
DEFINES
\family default 
\series default 

\newline 
Предназначена для флагов 
\family typewriter 
-D
\family default 
, определяющих макросы Си-препроцессора из командной строки компилятора.
\newline 
В эту переменную следует заносить макросы, используемые файлами в рабочем
 каталоге.
 Если макросы требуются используемому модулю, то они будут добавлены автоматичес
ки при подключении этого модуля.
\layout Standard

Флаги, указанные в переменных 
\family typewriter 
INCLUDES
\family default 
 и 
\family typewriter 
DEFINES
\family default 
, будут переданы любому компиляторы в любом режиме.
 Имеется еще несколько переменных для флагов, используемых только в конкретных
 вариантах сборки.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEFINES_DEBUG
\family default 
\series default 

\newline 
Макросы, указанные в этой переменной, будут переданы любому компилятору
 при сборке с отладочной информацией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEFINES_DEBUG_GCC
\family default 
\series default 

\newline 
Макросы, указанные в этой переменной, будут переданы компиляторам GNU при
 сборке с отладочной информацией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEFINES_DEBUG_SUNCC
\family default 
\series default 

\newline 
Макросы, указанные в этой переменной, будут переданы компиляторам фирмы
 Sun при сборке с отладочной информацией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEFINES_OPTIMIZE
\family default 
\series default 

\newline 
Макросы, указанные в этой переменной, будут переданы любому компилятору
 при сборке с оптимизацией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEFINES_OPTIMIZE_GCC
\family default 
\series default 

\newline 
Макросы, указанные в этой переменной, будут переданы компиляторам GNU при
 сборке с оптимизацией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEFINES_OPTIMIZE_SUNCC
\family default 
\series default 

\newline 
Макросы, указанные в этой переменной, будут переданы компиляторам фирмы
 Sun при сборке с оптимизацией.
\layout Standard

Значения по умолчанию следующие.
 Если не определена ни одна из переменных 
\family typewriter 
CL_DEFINES_DEBUG
\family default 
, 
\family typewriter 
CL_DEFINES_DEBUG_GCC
\family default 
 и 
\family typewriter 
CL_DEFINES_DEBUG_SUNCC
\family default 
, то принимается значение по умолчанию 
\family typewriter 
CL_DEFINES_DEBUG
\family default 
=
\family typewriter 
-DDEBUG
\family default 
.
 Если определена хоть одна из этих трех переменных (хотя бы на пустую строку),
 то других определений не добавляется.
 Аналогично, если не определена ни одна из переменных 
\family typewriter 
CL_DEFINES_OPTIMIZE
\family default 
, 
\family typewriter 
CL_DEFINES_OPTIMIZE_GCC
\family default 
 и 
\family typewriter 
CL_DEFINES_OPTIMIZE_SUNCC
\family default 
, то принимается значение по умолчанию 
\family typewriter 
CL_DEFINES_DEBUG
\family default 
=
\family typewriter 
-DDEBUG
\family default 
, а если хоть одна из этих трех переменных определена, то других определений
 не добавляется.
\layout Standard


\emph on 
Замечание: специальных переменных для режима 
\family typewriter 
CL_NDEBUG
\family default 
 не предусмотрено.
 Если ситуация требует использования этого режима (что бывает крайне редко),
 то требуемые флаги можно вычислить непосредственно в 
\family typewriter 
Makefile
\family default 
-е.
\layout Subsubsection

Прочие флаги компиляторов
\layout Standard

Кроме перечисленных выше, в системе cvslvk для передачи флагов компиляторам
 определены следующие переменные.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_CC_CFLAGS
\family default 
\series default 

\newline 
Флаги, указанные в этой переменной, будут переданы любому компилятору Си
 в любом режиме.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_CC_CXXFLAGS
\family default 
\series default 

\newline 
Флаги, указанные в этой переменной, будут переданы любому компилятору Си++
 в любом режиме.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_GCC_CFLAGS
\family default 
\series default 

\newline 
Флаги, указанные в этой переменной, будут переданы компилятору GNU С любом
 режиме.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_GCC_CXXFLAGS
\family default 
\series default 

\newline 
Флаги, указанные в этой переменной, будут переданы компилятору GNU С++ любом
 режиме.
 В этой переменной, в частности, можно задавать режим работы 
\family typewriter 
g++
\family default 
 с template-ами, если режим по умолчанию по каким-либо причинам неприемлим.
\begin_float footnote 
\layout Standard

Работа Sun CC c template-ами всегда обеспечивается автоматически при помощи
 добавления в его командную строку ключа 
\family typewriter 
-ptr$(CL_BD)
\family default 
, где 
\family typewriter 
$(CL_BD)
\family default 
 -- имя каталога сборки.
 Этот флаг добавляется и при компиляции, и при компоновке.
 В будущем возможно будет даны средства управления Sun-овскими template-ами.
\end_float 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_SUNCC_CFLAGS
\family default 
\series default 

\newline 
Флаги, указанные в этой переменной, будут переданы компилятору Sun С любом
 режиме.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_SUNCC_CXXFLAGS
\family default 
\series default 

\newline 
Флаги, указанные в этой переменной, будут переданы компилятору Sun С++ любом
 режиме.
\layout Standard

Если переменных, определенных в системе cvslvk, оказывается недостаточно,
 всегда можно в 
\family typewriter 
Makefile
\family default 
-е определить новые переменные и описать условия их использования.
\layout Subsubsection

Флаги компоновки
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
LDFLAGS
\begin_deeper 
\layout Standard

Эта переменная содержит флаги, передаваемые компоновщику при сборке исполняемого
 файла.
 В большинстве случаев она будет установлена автоматически.
 Ручная установка требуется только если подключаются библиотеки, не включенные
 в модули или псевдомодули системы cvslvk и не подключаемые автоматически
 этими модулями.
\layout Standard

Переменная 
\family typewriter 
LDFLAGS
\family default 
 подвергается достаточно сложной обработке (см.
 техническое описание системы).
 В частности, пути до всех использованных динамических библиотек прописываются
 в исполняемый файл, что обеспечивает корректное их нахождение без установки
 
\family typewriter 
LD_LIBRARY_PATH
\family default 
.
\layout Standard

Сейчас предполагается, что пользователь будет использовать эту переменную
 только для передачи флагов 
\family typewriter 
-L
\family default 
 (пути для поиска библиотек) и 
\family typewriter 
-l
\family default 
 (имена библиотек).
 Другие флаги не обрабатываются, а просто передаются компоновщику.
 Насколько это совместимо с обработкой флагов 
\family typewriter 
-l
\family default 
 и 
\family typewriter 
-L
\family default 
 -- неизвестно.
 Поэтому не рекомендуется добавлять другие флаги в 
\family typewriter 
LDFLAGS
\family default 
 без крайней надобности, а если появятся непонятные ошибки при компоновке
 или запуске программ -- удалить эти флаги.
\layout Standard

Возможно, в будущих версиях системы работа с 
\family typewriter 
LDFLAGS
\family default 
 будет расширена.
\end_deeper 
\layout Subsection

Сборка подкаталогов
\layout Standard

Как было замечено выше, в рабочем каталоге могут быть подкаталоги, которые
 тоже требуют сборки.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
SUBDIRS
\begin_deeper 
\layout Standard

Эта переменная содержит разделенный пробелами список подкаталогов рабочего
 каталога, которые также подлежат сборке при сборке рабочего каталога.
 В каждом из этих подкаталогов в порядке, в котором они перечислены в переменной
 будет вызвана команда 
\family typewriter 
make
\family default 
 с теми же параметрами, с какими она была вызвана пользователем в рабочем
 каталоге.
 Только после этого будет осуществлена сборка текущего каталога.
 
\layout Standard

Если сборка какого-либо из подкаталогов закончится ошибкой, то процесс будет
 остановлен.
 Сборка следующих подкаталогов (и текущего каталога) осуществлена не будет.
\end_deeper 
\layout Standard

Возможна ситуация, когда в текущем каталоге в 
\family typewriter 
Makefile
\family default 
-е не определяется ничего, кроме переменной 
\family typewriter 
SUBDIRS
\family default 
.
 Тогда сборка текущего каталога сводится только к сборке подкаталогов.
\layout Subsection

Параметры сборки
\layout Standard

Система cvslvk позволяет собирать каталог с различными параметрами и обеспечивае
т раздельное хранение объектных файлов и других генерируемых файлов, соответству
ющих различным параметрам сборки.
\layout Standard

Генерируемые файлы, соответствующие конкретному набору значений параметров
 сборки, помещаются в 
\emph on 
подкаталог сборки
\emph toggle 
.
 Имя каталога сборки представляет из себя разделенные дефисами значения
 параметров сборки.
 
\layout Standard

Исполняемый файл или библиотека, собираемый в текущем каталоге, также помещается
 в соответствующий подкаталог сборки.
 В текущий каталог помещается символьная ссылки на него.
 Если программа собрана с несколькими различными наборами значений параметров
 сборки (и в соответствующих подкаталогах сборки лежат в т.ч.
 исполняемые файлы), то команда make, которая должна вызвать сборку с одним
 из этих наборов параметров, просто переставит символьную ссылку в текущем
 каталоге на ранее собранный исполняемый файл, соответствующий затребованным
 параметрам сборки.
 Пересборка будет запущена только если этот файл устарел (т.е.
 какой-то из исходных файлов новее его).
\layout Standard

Всегда присутствуют следующие параметры сборки:
\layout Itemize

Архитектура машины, на которой осуществляется сборка.
 Определяется автоматически.
 Возможные значения в текущей версии системы -- 
\family typewriter 
x86
\family default 
 и 
\family typewriter 
sparc
\family default 
.
 В имени каталога сборки этот параметр будет на первом месте.
\layout Itemize

Операционная система, на которой осуществляется сборка.
 Определяется автоматически.
 Возможные значения в текущей версии системы -- 
\family typewriter 
linux
\family default 
 и 
\family typewriter 
solaris
\family default 
.
 В имени каталога этот параметр будет на втором месте.
\layout Itemize

Вариант сборки: 
\family typewriter 
debug
\family default 
, 
\family typewriter 
optimized
\family default 
 или 
\family typewriter 
ndebug
\family default 
.
 Устанавливается автоматически в зависимости от переменных 
\family typewriter 
CL_OPTIMIZE
\family default 
 и 
\family typewriter 
CL_NDEBUG
\family default 
.
 В имени каталога этот параметр будет на последнем месте.
\layout Standard

Также могут присутствовать следующие параметры сборки:
\layout Itemize

Компилятор.
 Возможные значения в текущей версии системы -- 
\family typewriter 
gcc
\family default 
 и 
\family typewriter 
suncc
\family default 
.
 Конкретное значение берется из 
\series bold 
переменной 
\family typewriter 
CL_COMP
\family default 
\series default 
 (т.е.
 значение по умолчанию -- 
\family typewriter 
gcc
\family default 
).
 
\begin_deeper 
\layout Standard

Компилятор считается параметром сборки, если выполняется как минимум одно
 из следующих условий:
\layout Itemize

установлена 
\series bold 
переменная 
\family typewriter 
CL_PARAM_COMP
\family default 
\series default 
,
\layout Itemize

в текущем каталоге собирается библиотека на языке Си++,
\layout Itemize

в текущем каталоге используется внешний модуль, среди параметров которого
 присутствует компилятор.
\end_deeper 
\layout Itemize

Тип библиотеки.
 Возможные значения -- 
\family typewriter 
shared
\family default 
 и 
\family typewriter 
static
\family default 
.
 Конкретное значение берется из 
\series bold 
переменной 
\family typewriter 
CL_LTYPE
\family default 
\series default 
 (т.е.
 значение по умолчанию -- 
\family typewriter 
shared
\family default 
).
\begin_deeper 
\layout Standard

Тип библиотеки считается параметром сборки, если выполняется как минимум
 одно из следующих условий:
\layout Itemize

установлена 
\series bold 
переменная 
\family typewriter 
CL_PARAM_LTYPE
\family default 
\series default 
,
\layout Itemize

в текущем каталоге собирается библиотека.
\end_deeper 
\layout Itemize

Любые пользовательские параметры.
\begin_deeper 
\layout Standard

Если установлена 
\series bold 
переменная 
\family typewriter 
CL_PARAM_OTHER
\family default 
\series default 
, то ее содержимое рассматривается как разделенный дефисами список пользовательс
ких параметров сборки.
\layout Standard

Значение переменной 
\family typewriter 
CL_PARAM_OTHER
\family default 
 рекомендуется вычислять в 
\family typewriter 
Makefile
\family default 
-е в зависимости от параметров командной строки, с разумными значениями
 по умолчанию.
\end_deeper 
\layout Standard

При составлении имени каталога сборки перечисленные параметры включаются
 в указанном порядке, начиная с 3-го места.
\layout Subsection

Цели 
\family typewriter 
make
\family default 
, определенные в системе cvslvk
\layout Standard

По умолчанию команда 
\family typewriter 
make
\family default 
 в системе cvslvk выполняет сборку каталога.
\layout Itemize

Если определена переменная 
\family typewriter 
EXECUTABLE
\family default 
, то при сборке каталога будет собран исполняемый файл
\layout Itemize

Если определена переменная 
\family typewriter 
LIBRARY
\family default 
 (или 
\family typewriter 
INTERNAL_LIBRARY
\family default 
), то при сборке каталога будет собрана библиотека.
 Одновременное определение переменных 
\family typewriter 
EXECUTABLE
\family default 
 и 
\family typewriter 
LIBRARY
\family default 
 является ошибкой.
\layout Itemize

Если определена переменная 
\family typewriter 
SUBDIRS
\family default 
, то перед сборкой исполняемого файла или библиотеки будет осуществлена
 сборка каталогов, перечисленных в переменной 
\family typewriter 
SUBDIRS
\family default 
.
\layout Standard

Как минимум одна из перечисленных переменных должна быть определена, иначе
 любая операция системы cvslvk в данном каталоге будет немедленно аварийно
 завершена.
\layout Standard

Кроме сборки каталога, определены следующие команды.
\layout Subsubsection

Команды очистки
\layout Standard

Имеются две команды очистки:
\layout Itemize


\family typewriter 
make
\protected_separator 
clean
\family default 
 -- удаляет результаты одной сборки каталога.
 
\begin_deeper 
\layout Standard

Удаляются те и только те файлы, которые собираются при сборке каталога при
 тех же установках переменных (в командной строке, в 
\family typewriter 
Makefile
\family default 
-е, в переменных окружения).
 Файлы, созданные при других установках переменных (и не создаваемые при
 данных), удалены не будут.
 В частности, будет удален ровно один каталог сборки.
\end_deeper 
\layout Itemize


\family typewriter 
make
\protected_separator 
cleanall
\family default 
 -- удаляет все файлы, созданные системой cvslvk.
 В частности, удаляются 
\emph on 
все
\emph toggle 
 созданные каталоги сборки.
\layout Standard

Имеются две переменные, при помощи которых можно заставить команды 
\family typewriter 
make
\protected_separator 
clean
\family default 
 и 
\family typewriter 
make
\protected_separator 
cleanall
\family default 
 производить дополнительные очистки.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_CLEAN_FILES
\begin_deeper 
\begin_deeper 
\layout Standard

Содержит дополнительный список файлов, удаляемый по команде 
\family typewriter 
make
\protected_separator 
clean
\family default 
.
 Этот список будет передан команде 
\family typewriter 
rm
\protected_separator 
-rf
\family default 
.
\end_deeper 
\end_deeper 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_CLEAN
\begin_deeper 
\begin_deeper 
\layout Standard

Содержит разделенный пробелами список дополнительных 
\family typewriter 
make
\family default 
-правил, которые следует выполнить перед удалением файлов.
\end_deeper 
\end_deeper 
\layout Standard

Переменные 
\family typewriter 
CL_CLEAN_FILES
\family default 
 и 
\family typewriter 
CL_CLEAN
\family default 
 обеспечивают возможность удаления файлов, созданных пользовательскими программа
ми или дополнительными пользовательскими 
\family typewriter 
make
\family default 
-правилами.
 Однако, если пользовательские 
\family typewriter 
make
\family default 
-правила создают временные файлы, то рекомендуется их размещать в каталоге
 сборки -- тогда они не будут засорять рабочий каталог и будут автоматически
 удалены при очистке без дополнительных определений.
 Имя каталога сборки доступно в 
\family typewriter 
Makefile
\family default 
-е ниже включения файла 
\family typewriter 
$(CL_DIR)/Makefile.cvslvk
\family default 
 в 
\series bold 
переменной 
\family typewriter 
CL_BD
\family default 
\series default 
.
\newline 

\layout Standard

Если определена переменная 
\family typewriter 
SUBDIRS
\family default 
, то перед очисткой текущего каталога (но после выполнения правил из переменной
 
\family typewriter 
CL_CLEAN
\family default 
) будет вызвана та же (
\family typewriter 
clean
\family default 
 или 
\family typewriter 
cleanall
\family default 
) очистка перечисленных в переменной 
\family typewriter 
SUBDIRS
\family default 
 каталогов.
 Команда 
\family typewriter 
make
\protected_separator 
clean_subdirs
\family default 
 вызовет только очистку каталогов 
\family typewriter 
SUBDIRS
\family default 
, без очистки текущего каталога.
\layout Subsubsection

Команда инсталляции
\layout Standard

Команда 
\family typewriter 
make
\protected_separator 
install
\family default 
 осуществляет инсталляцию программы или библиотеки, собираемой в рабочем
 каталоге.
 Указывается путь для инсталляции, куда в подкаталог 
\family typewriter 
bin/
\family default 
 копируется исполняемый файл, в подкаталог 
\family typewriter 
lib/
\family default 
 -- библиотека, и т.д.
 Инсталляция управляется набором переменных.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_PREFIX
\family default 
\series default 

\newline 
Указывает путь для инсталляции.
 Если эта переменная не определена, то команда 
\family typewriter 
make
\protected_separator 
install
\family default 
 будет аварийно завершена.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_INSTALL_PARTS
\family default 
\series default 

\newline 
Может содержать разделенный пробелами список 
\family typewriter 
make
\family default 
-правил, которые надо выполнить перед инсталляцией.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
EXPORT_INCLUDES
\family default 
\series default 

\newline 
Может содержать разделенный пробелами список файлов и каталогов, которые
 следует в процессе инсталляции скопировать в каталог 
\family typewriter 
$(CL_PREFIX)/include/
\family default 
.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
SCRIPTS
\family default 
\series default 

\newline 
Может содержать разделенный пробелами дополнительный список файлов (например,
 скриптов), которые следует в процессе инсталляции скопировать в каталог
 
\family typewriter 
$(CL_PREFIX)/bin/
\family default 
.
\layout Standard

По команде 
\family typewriter 
make
\protected_separator 
install
\family default 
 выполняются следующие действия:
\layout Itemize

вызывается сборка каталога (с явно установленной переменной 
\family typewriter 
CL_PREFIX
\family default 
);
\layout Itemize

если определена переменная 
\family typewriter 
SUBDIRS
\family default 
, то вызывается команда make
\protected_separator 
install в каждом из каталогов, перечисленных в этой переменной;
\layout Itemize

если система находится в режиме сборки программы (т.е.
 определена переменная 
\family typewriter 
EXECUTABLE
\family default 
), то исполняемый файл программы копируется в каталог 
\family typewriter 
$(CL_PREFIX)/bin
\family default 
; если система находится в режиме сборки библиотеки (т.е.
 определена переменная 
\family typewriter 
LIBRARY
\family default 
), то собранная библиотека копируется в каталог 
\family typewriter 
$(CL_PREFIX)/lib
\family default 
;
\layout Itemize

если определена переменная 
\family typewriter 
EXPORT_INCLUDES
\family default 
, то перечесленные в ней файлы и каталоги копируются в каталог 
\family typewriter 
$(CL_PREFIX)/include
\family default 
;
\layout Itemize

если определена переменная 
\family typewriter 
SCRIPTS
\family default 
, то перечесленные в ней файлы копируются в каталог 
\family typewriter 
$(CL_PREFIX)/bin
\family default 
.
\layout Subsubsection

Другие команды (цели 
\family typewriter 
make
\family default 
)
\layout Itemize

Команды 
\family typewriter 
make
\protected_separator 
create_wi
\family default 
, 
\family typewriter 
make
\protected_separator 
update_wi
\family default 
, 
\family typewriter 
make
\protected_separator 
show_wi
\family default 
, связанные с использованием модулей, рассматриваются в разделе 
\begin_inset LatexCommand \ref{sec: modules}

\end_inset 

.
\layout Itemize

Всякий создаваемый файл (например, объектный) можно создать явно командой
 
\family typewriter 
make
\protected_separator 
<имя-файла>
\family default 
.
 Следует иметь в виду, однако, что файл скорее всего будет создан не в текущем
 каталоге, а в подкаталоге сборки.
 
\layout Itemize

Новые цели 
\family typewriter 
make
\family default 
 могут определяться в 
\family typewriter 
Makefile
\family default 
-е или в подключаемых модулях.
\layout Subsection

Модель использования модулей в системе cvslvk
\begin_inset LatexCommand \label{sec: modules}

\end_inset 


\layout Subsubsection

Понятие модуля
\layout Standard

Понятие 
\emph on 
модуля
\emph toggle 
 является одним из основных понятий системы cvslvk.
 Это достаточно абстрактное понятие, определить его сложно.
 В наиболее общем случае это некоторая совокупность файлов, в какой-то мере
 связанных между собой и в какой-то мере независимых от внешнего мира, которую
 можно как-то 
\emph on 
использовать
\emph toggle 
.
\layout Standard

В качестве примеров модулей можно привести: 
\layout Itemize

отдельную программу, 
\layout Itemize

совокупность программ, 
\layout Itemize

библиотеку с набором include-файлов, 
\layout Itemize

средство создания парсера по грамматике,
\layout Standard

и т.д.
\layout Standard

Могут быть модули, которые сначала требуется собрать и только потом можно
 использовать.
 Могут быть модули, готовые к использованию немедленно (например, совокупности
 скриптов).
 Если модуль необходимо собрать, то эта сборка может быть осуществлена при
 помощи системы cvslvk, или же какими-то иными средствами.
\layout Subsubsection

Понятие использования модуля
\layout Standard

При сборке каталога в системе cvslvk может быть затребовано 
\emph on 
использование
\emph toggle 
 некоторых модулей.
 
\layout Standard

Каждый модуль 
\begin_inset Quotes eld
\end_inset 

знает
\begin_inset Quotes erd
\end_inset 

, что значит его использовать.
 Т.е.
 он предоставляет системе cvslvk некоторый интерфейс, через который определяется
 семантика использования этого модуля.
\layout Standard

Модуль может быть использован как в процессе сборки каталога, так и при
 запуске и работе собранной программы.
\layout Subsubsection

Рабочая инсталляция модуля
\layout Standard

Для того, чтобы в системе cvslvk можно было использовать некоторый модуль,
 должна присутствовать 
\emph on 
рабочая инсталляция
\emph toggle 
 этого модуля.
 Рабочая инсталляция представляет из себя инсталляцию иерархии файлов, из
 которых состоит модуль, в каталоге с определенным именем, расположенном
 в определенном месте.
\layout Standard

Одновременно в системе может присутствовать несколько рабочих инсталляций
 одного модуля.
 Например, если модуль представляет из себя библиотеку, то могут быть инсталляци
и со статической и с динамической версиями этой библиотеки, или инсталляции,
 собранные разными компиляторами (конкретный компилятор существенен для
 Си++-библиотек), или инсталляции с различными пользовательскими параметрами.
 Таким образом, имя рабочей инсталляции состоим из имени модуля и параметров.
 Эти части имени разделяются символом подчеркивания.
 Параметры разделяются дефисами и рассматриваются как неупорядоченное множество
 строк.
 
\layout Standard

Например, рабочая инсталляция может иметь имя
\layout LyX-Code

libmon_sparc-solaris-gcc-shared-mtfloat-solthread-optimized
\layout Standard

Имя модуля здесь -- 
\family typewriter 
libmon
\family default 
.
 Имеется 7 параметров рабочей инсталляции.
 Из них три системных обязательных -- архитектура 
\family typewriter 
sparc
\family default 
, операционная система 
\family typewriter 
solaris
\family default 
 и вид сборки 
\family typewriter 
optimized
\family default 
, два системных необязательных -- компилятор gcc и тип библиотеки shared,
 и два пользовательских -- строки 
\family typewriter 
mtfloat
\family default 
 и 
\family typewriter 
solthread
\family default 
.
\layout Standard

В текущей версии системы cvslvk рабочие инсталляции располагаются в подкаталогах
 каталоги системы 
\family typewriter 
$CL_DIR
\family default 
, причем имя подкаталога и считается именем инсталляции и должно удовлетворять
 описанным соглашениям.
\layout Standard

Рабочие инсталляции могут быть созданы при помощи системы cvslvk -- в этом
 случае параметры сборки автоматически становятся параметрами рабочей инсталляци
и.
 Но можно создавать рабочие инсталляции и вручную, поместив в каталог 
\family typewriter 
$CL_DIR
\family default 
 соответствующий подкаталог и зарегисирировав инсталляцию командой 
\family typewriter 
cvslvk
\protected_separator 
make_rules
\family default 
.
\layout Subsubsection

Требование на использование модуля
\layout Standard

Система выберет конкретную рабочую инсталляцию для использования в соответствии
 с 
\emph on 
требованием на использование модуля
\emph toggle 
.
 
\layout Standard

Требование состоит из имени модуля и, возможно, параметров рабочей инсталляции.
 Параметры в требовании рассматриваются как неупорядоченное множество строк
 (возможно, пустое).
 Для удовлетворения требования будет выбрана некоторая инсталляция модуля
 с указанным именем, множество параметров которой включает (в смысле теории
 множеств) множество параметров в требовании.
 
\layout Standard

Параметры, соответствующие текущей архитектуре и операционной системе, автоматич
ески добавляются в требование.
\layout Standard

В случае, если имеется несколько рабочих инсталляций, удовлетворяющих требование
, то будет выбрана одна из них.
 Параметры 
\family typewriter 
gcc
\family default 
, 
\family typewriter 
optimized
\family default 
 и 
\family typewriter 
shared
\family default 
 повышают приоритет конкретной инсталляции в этом выборе соответственно
 на 4, 2 и 1; если получаются инсталляции с одинаковым приоритетом, то выбираетс
я 
\begin_inset Quotes eld
\end_inset 

первая попавшаяся
\begin_inset Quotes erd
\end_inset 

 из них.
\layout Subsubsection

Семантика использования модуля: файл 
\family typewriter 
rules.cvslvk
\layout Standard

После того, как система принимает решение об использовании конкретной рабочей
 инсталляции, она автоматически включает в 
\family typewriter 
Makefile
\family default 
 файл 
\family typewriter 
rules.cvslvk
\family default 
, предоставляемый модулем.
 В этом файле могут задаваться дополнительные переменные и правила.
 
\layout Standard

Рассмотрим случай, когда модуль представляет из себя библиотеку.
\layout Standard

Для корректного использования библиотеки необходимо добавить к ключам компиляции
 ключ 
\family typewriter 
-I<
\family default 
путь-к-include-файлам
\family typewriter 
> 
\family default 
и ключам компоновки ключи 
\family typewriter 
-L<
\family default 
путь-к-файлу-библиотеки
\family typewriter 
>
\protected_separator 
-l<
\family default 
имя-библиотеки
\family typewriter 
>
\family default 
.
 Пусть библиотека называется 
\family typewriter 
mylib
\family default 
, ее include-файлы находятся в подкаталоге 
\family typewriter 
include/
\family default 
 рабочей инсталляции, а сама библиотека libmylib.so находится в подкаталоге
 
\family typewriter 
lib/
\family default 
 рабочей инсталляции.
\layout Standard

В момент включения файла 
\family typewriter 
rules.cvslvk
\family default 
 переменная 
\family typewriter 
CL_WI
\family default 
 будет содержать путь до рабочей инсталляции.
 Соответственно, нам надо добавить в переменную 
\family typewriter 
INCLUDES
\family default 
 ключ 
\family typewriter 
-I$(CL_WI)/include
\family default 
, а в переменную 
\family typewriter 
LDFLAGS
\family default 
 -- ключи 
\family typewriter 
-L$(CL_WI)/lib
\protected_separator 
-lxxx
\family default 
, где 
\family typewriter 
xxx
\family default 
 -- имя библиотеки.
 Однако, непосредственно сделать это при помощи операции 
\family typewriter 
+=
\family default 
 нельзя.
\layout Standard
\pextra_type 1 \pextra_width 1cm


\size small 
В 
\family typewriter 
GNU Makefile
\family default 
-е подстановка значений переменных может быть двух видов -- поздняя и немедленна
я.
\begin_float footnote 
\layout Standard

В более простых 
\family typewriter 
make
\family default 
-ах подстановка всегда 
\emph on 
поздняя
\emph toggle 
.
\end_float 

\size small 
 Их различие видно из следующего примера.
\layout LyX-Code
\align block \pextra_type 1 \pextra_width 1cm


\size small 
X = xxx-$(Y) 
\protected_separator 
 
\protected_separator 
 
\protected_separator 
X := xxx-$(Y)
\layout LyX-Code
\align block \pextra_type 1 \pextra_width 1cm


\size small 
Y = yyy 
\protected_separator 
 
\protected_separator 
 
\protected_separator 
 
\protected_separator 
 
\protected_separator 
 Y = yyy
\layout Standard
\pextra_type 1 \pextra_width 1cm


\size small 
Вопрос: чему будет равно значение переменной 
\family typewriter 
X
\family default 
 (переменная 
\family typewriter 
Y
\family default 
 не была определена выше).
 Ответ: в первом случае (слева) строке 
\family typewriter 
xxx-yyy
\family default 
, во втором случае (справа) строке 
\family typewriter 
xxx-
\family default 
.
 
\layout Standard
\pextra_type 1 \pextra_width 1cm


\size small 
В первом случае для переменной 
\family typewriter 
X
\family default 
 имеет место поздняя подстановка.
 В первой строке запоминается, что в переменной 
\family typewriter 
X
\family default 
 используется значение переменной 
\family typewriter 
Y
\family default 
, подстановки значения переменной 
\family typewriter 
Y
\family default 
 не производится.
 Если переменная 
\family typewriter 
X
\family default 
 сама будет использоваться в определениях других переменных, подстановки
 значения также не произойдет.
 Подстановка значения осуществляется позже, когда переменная 
\family typewriter 
X
\family default 
 будет использоваться в правилах.
 Причем подстановка произойдет по окончании чтения Makefile-а, т.е.
 переменные могут переопределяться и ниже по тексту, чем указаны правила.
\layout Standard
\pextra_type 1 \pextra_width 1cm


\size small 
Во втором случае подстановка значения производится немедленно.
 Этого требует операция 
\family typewriter 
:=
\family default 
.
\layout Standard

Переменная 
\family typewriter 
CL_WI
\family default 
 требует немедленной подстановки ее значения, т.к.
 позже, при подключении других рабочих инсталляций, это значение изменится.
 Однако, пользоваться операцией 
\family typewriter 
:=
\family default 
 в определении переменных 
\family typewriter 
INCLUDES
\family default 
, 
\family typewriter 
DEFINES
\family default 
 и 
\family typewriter 
LDFLAGS
\family default 
 нельзя: в системе cvslvk используется поздняя подстановка в обработке этих
 переменных.
 Поэтому правильный файл 
\family typewriter 
rules.cvslvk
\family default 
 для библиотеки выглядит следующим образом:
\layout LyX-Code

override MYLIB_INCLUDES := -I$(CL_WI)/include
\layout LyX-Code

override MYLIB_LDFLAGS := -L$(CL_WI)/lib -lmylib
\layout LyX-Code

override INCLUDES += $(MYLIB_INCLUDES)
\layout LyX-Code

override LDFLAGS += $(MYLIB_LDFLAGS)
\layout Standard

Операция 
\family typewriter 
override
\family default 
 служит для переопределения переменной даже если она была определена выше
 по тексту или в командной строке.
\newline 

\layout Standard

В файле 
\family typewriter 
rules.cvslvk
\family default 
 могут быть любые конструкции 
\family typewriter 
GNU
\protected_separator 
Makefile
\family default 
-а.
 Например, там могут определяться переменные для использования в других
 модулях.
 Из-за поздней подстановки значений данные будут корректно переданы независимо
 от порядка подключения инсталляций.
 Однако, следует быть осторожным при применении условных конструкций 
\family typewriter 
Makefile
\family default 
-а типа 
\family typewriter 
ifdef
\family default 
: в них проверяется текущее состояние переменных, поэтому не следует в них
 использовать переменные, определяемых в других рабочих инсталляциях, т.к.
 они могут быть еще не определены.
\layout Standard

К моменту включения файлов 
\family typewriter 
rules.cvslvk
\family default 
 параметры сборки уже установлены, переопределить их в файлах 
\family typewriter 
rules.cvslvk
\family default 
 нельзя.
 Таким образом, неявные параметры сборки, возникающие при подключении рабочих
 инсталляций, в текущей версии системы cvslvk невозможны.
 Также в файлах 
\family typewriter 
rules.cvslvk
\family default 
 нельзя изменить компилятор (переменная 
\family typewriter 
CL_COMP
\family default 
) и тип библиотеки (переменная 
\family typewriter 
CL_LTYPE
\family default 
).
 Все остальные переменные (в т.ч.
 
\family typewriter 
INCLUDES
\family default 
, 
\family typewriter 
DEFINES
\family default 
, 
\family typewriter 
LDFLAGS
\family default 
, флаги компилятора и т.д.) могут быть доопределены или переопределены.
 
\layout Standard

В файлах 
\family typewriter 
rules.cvslvk
\family default 
 (а также в пользовательском Makefile-е ниже включения $(CL_DIR)/Makefile.cvslvk)
 доступны следующие переменные:
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_ARCH
\family default 
\series default 
 
\newline 
Содержит архитектуру системы, на которой идет сборка.
 Возможные значения в текущей версии системы cvslvk: 
\family typewriter 
sparc
\family default 
 и 
\family typewriter 
x86
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_OS
\family default 
\series default 
 
\newline 
Содержит операционную систему, на которой идет сборка.
 Возможные значения в текущей версии системы cvslvk: 
\family typewriter 
solaris
\family default 
 и 
\family typewriter 
linux
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_BD
\family default 
\series default 
 
\newline 
Содержит имя каталога сборки (т.е.
 разделенные дефисами параметры сборки)
\layout Subsubsection

Зависимости между модулями
\layout Standard

Модули могут зависеть друг от друга.
 Некоторый модуль может объявить, что для его использования необходимо также
 использовать некоторый другой модуль (или модули), т.е.
 представить дополнительные требования на использование.
 Эти требования могут добвалять параметры к уже имеющимся требованиям (при
 этом множества параметров объединяются) или требовать новый модуль.
 Различные рабочие инсталляции одного модуля могут иметь разные требования.
\layout Standard

При подключении модулей система cvslvk попытается удовлетворить все возникающие
 требования.
 Если в какой-то момент этого не получится, т.е.
 не окажется рабочей инсталляции с соответствующими параметрами, то будет
 произведен откат и попытка использовать другие рабочие инсталляции для
 удовлетворения предыдущих требований.
 Фактически осуществляется поиск вглубь.
 Если поиск завершится неудачей, т.е.
 все требования удовлетворить не удастся, то процесс сборки каталога будет
 аварийно завершен.
\layout Standard

Имеется возможность просмотреть этот процесс при помощи команды 
\family typewriter 
make
\protected_separator 
show_wi
\family default 
.
\layout Standard

Такой параметризованный механизм зависимости между модулями позволяет, в
 частности, добиться согласованных параметров различных подключаемых модулей.
 Например, один из параметров модуля 
\family typewriter 
libmon
\family default 
 -- библиотеки среды прогона DYANA -- определяет тип модельного времени.
 Библиотечная модель 
\family typewriter 
Ethernet
\family default 
 может работать с разными типами модельного времени (и соответственно тоже
 имеет этот параметр).
 Однако, необходимо соответствие между типами модельного времени в этих
 библиотеках, т.е.
 совпадение параметров.
 Более того, пользователь может и не знать про существование этого параметра
 и соответственно про необходимость указанного согласования.
 
\layout Standard

Решается эта проблема при помощи введения зависимости каждой инсталляции
 модуля 
\family typewriter 
Ethernet
\family default 
 от модуля 
\family typewriter 
libmon
\family default 
 с соответствующим значением параметра.
 Тогда требование модуля 
\family typewriter 
Ethernet
\family default 
 всегда автоматически наложит требование на совпадение параметра.
 При этом конкретное значение параметра может оказаться любым -- были бы
 только доступны инсталляции 
\family typewriter 
libmon
\family default 
 и 
\family typewriter 
Ethernet
\family default 
 с этим значением параметра.
 В дальнейшем пользователю может понадобиться конкретный тип модельного
 времени.
 Тогда он укажет его в требовании, например 
\family typewriter 
Ethernet_mtdouble
\family default 
.
 Теперь будут подключаться рабочие инсталляции с конкретным значением параметра
 -- но по-прежнему согласованные.
\layout Standard

Еще одна возможность механизма зависимостей -- подключение совокупности
 модулей по одному требованию.
 Например, можно сознать пустой модуль с именем 
\family typewriter 
DYANA
\family default 
, который зависит от всех компонентов среды.
 Тогда требование использования этого модуля автоматически подключит все
 компоненты (причем их согласованные версии, что будет обеспечено другими
 зависимостями).
\layout Standard

Список зависимостей находится врабочей инсталляции в файле с именем 
\family typewriter 
depend.cvslvk
\family default 
.
 Формат тот же что у требований на использование: 
\family typewriter 
<
\family default 
имя
\family typewriter 
>
\family default 
 или 
\family typewriter 
<
\family default 
имя
\family typewriter 
>_<
\family default 
параметры
\family typewriter 
>
\family default 
.
 Параметры разделяются дефисами.
 Требования разделяются пробелами или переводами строки.
\layout Subsubsection

Псевдомодули
\layout Standard

Могут быть модули, в которых нет ни одного файла.
 Рабочая инсталляция такого модуля будет содержать только служебные файлы
 системы cvslvk -- файл 
\family typewriter 
rules.cvslvk
\family default 
 и/или файл 
\family typewriter 
depend.cvslvk
\family default 
.
 Такие модули называются 
\emph on 
псевдомодулями
\emph toggle 
.
\layout Standard

Одно из применений псевдомодулей было рассмотрено выше -- для подключения
 нескольких модулей по одному требованию.
 В рабочей инсталляции такого псевдомодуля скорее всего будет только файл
 
\family typewriter 
depend.cvslvk
\family default 
.
\layout Standard

Другое важное применение псевдомодулей -- обеспечение из системы cvslvk
 доступа до пакетов, установленных на машине.
 Например, если в иерархии 
\family typewriter 
/usr/local
\family default 
 установлена некоторая библиотека 
\family typewriter 
libXYZ
\family default 
 (т.е.
 в каталоге 
\family typewriter 
/usr/local/include
\family default 
 имеются include-файлы этой библиотеки, а в каталоге 
\family typewriter 
/usr/local/lib
\family default 
 -- сама библиотека
\family typewriter 
 libXYZ.so
\family default 
), то подключать эту библиотеку к программе, собираемой при помощи системы
 cvslvk, можно двумя способами.
 Можно установить в 
\family typewriter 
Makefile
\family default 
-е соответетвующие переменные:
\layout LyX-Code

INCLUDES = -I/usr/local/include
\layout LyX-Code

LDFLAGS = -L/usr/local/lib -lXYZ
\layout Standard

Но можно вместо этого создать соответствующий библиотеке псевдомодуль.
 В его рабочей инсталляции в файле rules.cvslvk должно стоять 
\layout LyX-Code

override INCLUDES += -I/usr/local/include
\layout LyX-Code

override LDFLAGS += -L/usr/local/lib -lXYZ
\layout Standard

Тогда для использования этой библиотеки можно будет просто добавлять соответству
ющее требование в переменную 
\family typewriter 
CL_USE_MODULES
\family default 
.
 Все пользователи и все проекты, которые захотят использовать эту библиотеку,
 будут разделять между собой определения из псевдомодуля.
\layout Standard

В данном примере файл 
\family typewriter 
rules.cvslvk
\family default 
, подключаемый с псевдомодулем, очень прост и едва ли оправдывает его создание.
 Однако, в более сложных случаях создание псевдомодуля безусловно полезна.
 Например, известная библиотека 
\family typewriter 
Qt
\family default 
 использует свой собственный препроцессор 
\family typewriter 
moc
\family default 
.
 Для своевременного запуска этого препроцессора требуются дополнительные
 правила в 
\family typewriter 
Makefile
\family default 
-е, причем достаточно громоздкие.
 Если один раз указать эти правила в псевдомодуле и отладить их один раз,
 то будет значительная экономия по сравнению с написанием и отладкой этих
 правил в каждом проекте, использующем библиотеку 
\family typewriter 
Qt
\family default 
.
 Аналогичная ситуация имеет место, например, со средствами автоматического
 создания парсера по грамматике.
\layout Standard

Необходимые сведения по написанию соответствующих файлов 
\family typewriter 
rules.cvslvk
\family default 
 приведены в разделе 
\begin_inset LatexCommand \ref{sec: newmodules}

\end_inset 

.
\layout Subsection

Использование модулей при сборке каталога
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_USE_MODULES
\begin_deeper 
\layout Standard

В этой переменной указывается разделенный пробелами список требований на
 использование модулей.
 Для каждого требования будет подключена удовлетворяющая его рабочая инсталляция.
 Также возможно будут подключены дополнительные рабочие инсталляции для
 удовлетворения зависимостей.
\layout Standard

В случае невозможности удовлетворения зависимостей сборка каталога будет
 аварийно прервана.
\end_deeper 
\layout Standard

Команда 
\family typewriter 
make
\protected_separator 
show_wi
\family default 
 выдаст список действий, выполняемых при удовлетворении требований.
\layout Standard

Если при сборке каталога используются модули (т.е.
 если определена переменная 
\family typewriter 
CL_USE_MODULES
\family default 
), то процесс сборки каталога начинает неявно зависеть от внешних по отношению
 к этому каталогу явлений: 
\layout Itemize

при изменениях в использованной рабочей инсталляции очередная команда 
\family typewriter 
make
\family default 
 вызовет пересборку всех файлов, хотя файлы возможно и не менялись.
 
\layout Itemize

при появлении новой рабочей инсталляции, при помощи которой можно удовлетворить
 требования, очередная команда 
\family typewriter 
make
\family default 
 может начать использовать новую инсталляцию вместо использованных ранее.
 Если рабочие инсталляции сделаны недостаточно аккуратно, то такая подмена
 может привести к ошибкам.
\layout Subsection

Использование модулей после сборки каталога
\layout Standard

Система cvslvk позволяет использовать рабочие инсталляции модулей не только
 при сборе каталога, но и позже.
\layout Standard

Если модуль представляет из себя разделяемую библиотеку, то рабочая инсталляция
 используется неявно при каждом запуске собранной программы -- из рабочей
 инсталляции подгружается код разделяемой библиотеки.
 Необходимые настройки (при помощи механизма 
\family typewriter 
rpath
\family default 
 -- записи местоположения разделяемых библиотек непосредственно в исполняемый
 файл) устанавливаются системой cvslvk автоматически.
\layout Standard

Имеется и механизм для явного использования модулей после сборки.
 Это делается при помощи символьных ссылок.
 В процессе сборки в рабочем каталоге устанавливаются символьные ссылки
 на расположенные в рабочей инсталляции файлы (например, скрипты, программы
 или файлы данных), и эти файлы оказываются доступными из текущего каталога.
 Если у пользователя имеется текущий каталог (
\begin_inset Quotes eld
\end_inset 


\family typewriter 
.
\family default 

\begin_inset Quotes erd
\end_inset 

) в переменной среды 
\family typewriter 
PATH
\family default 
, то программы из рабочих инсталляций делаются доступными прозрачно -- пользоват
ель может даже не знать, что это программы из рабочих инсталляций.
 В различных рабочих инсталляциях под одними именами могут стоять различные
 программы (например, работающие с различными форматами данных) -- тогда
 получается, что система cvslvk осуществляет автоматический выбор нужной
 программы.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_SYMLINKS
\begin_deeper 
\layout Standard

В этой переменной указывается разделенный пробелами список полных путей
 до файлов, символьные ссылки на которые пользователь получит в рабочем
 каталоге.
\layout Standard

Эта переменная скорее всего должна определяться в файлах 
\family typewriter 
rules.cvslvk
\family default 
 с использованием значения 
\family typewriter 
$(CL_WI)
\family default 
.
 Например, если модуль содержит программу 
\family typewriter 
bin/trcdump
\family default 
, доступ до которой следует дать пользователю, то в файле 
\family typewriter 
rules.cvslvk
\family default 
 должна быть строка
\layout LyX-Code

override CL_SYMLINKS += $(CL_WI)/bin/trcdump
\layout Standard

Значение переменной 
\family typewriter 
CL_SYMLINKS
\family default 
 используется только в режиме сборки программы (т.е.
 когда опрелена переменная 
\family typewriter 
EXECUTABLE
\family default 
)
\end_deeper 
\layout Subsection

Создание модулей и их рабочих инсталляций 
\begin_inset LatexCommand \label{sec: newmodules}

\end_inset 


\layout Standard

Как было отмечено выше, рабочие инсталляции модулей могут быть созданы как
 при помощи системы cvslvk, так и иными средствами.
\layout Subsubsection

Средства создания рабочих инсталляций в системе cvslvk
\layout Standard

В системе cvslvk модуль собирается из одного каталога или из иерархии каталогов,
 сцепляемой при помощи переменных 
\family typewriter 
SUBDIRS
\family default 
.
 Команды создания рабочей инсталляции во многом аналогичны команде 
\family typewriter 
make
\protected_separator 
install
\family default 
.
 Отличия заключаются в следующем.
\layout Itemize

Путь для инсталляции (т.е.
 значение переменной 
\family typewriter 
CL_PREFIX
\family default 
) автоматически устанавливается на значение 
\family typewriter 
$(CL_DIR)/<
\family default 
имя-модуля
\family typewriter 
>_<
\family default 
параметры-сборки
\family typewriter 
>
\family default 
.
\layout Itemize

Если в рабочем каталоге имеется файлы
\family typewriter 
 rules.cvslvk
\family default 
 и 
\family typewriter 
depend.cvslvk
\family default 
, то они копируется в рабочую инсталляцию.
\newline 
Если определена переменная 
\family typewriter 
SUBDIRS
\family default 
, то система сделает попытки переписать эти файлы и из перечисленных в переменно
й 
\family typewriter 
SUBDIRS
\family default 
 каталогов.
 Если окажется, что файл имеется более чем в одном из них, то в рабочей
 инсталляции останется файл из последнего каталога (при этом, как обычно,
 текущий каталог проверяется после 
\family typewriter 
SUBDIRS
\family default 
).
\layout Itemize

Имеется возможность инсталлировать дополнительные файлы.
 Текущая версия системы явно поддерживает установку только дополнительных
 скриптов, но это легко расширяется при помощи условной конструкции в 
\family typewriter 
Makefile
\family default 
-е, которая добавляет дополнительные правила в переменную 
\family typewriter 
CL_INSTALL_PARTS
\family default 
 когда определена 
\series bold 
переменная 
\family typewriter 
CL_INSTALL_WI
\family default 
\series default 
.
\layout Standard

Имеются две команды для создания рабочих инсталляций: 
\family typewriter 
make
\protected_separator 
create_wi
\family default 
 и 
\family typewriter 
make
\protected_separator 
update_wi
\family default 
.
 Они различаются только поведением в случае, когда создаваемая рабочая инсталляц
ия уже есть.
 В этом случае команда 
\family typewriter 
make
\protected_separator 
create_wi 
\family default 
выдаст сообщение об ошибке, а команда 
\family typewriter 
update_wi
\family default 
 -- сделает попытку удалить имеющуюся рабочую инсталляцию и создать новую.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_MODULE
\newline 

\family default 
\series default 
В этой переменной указывается имя модуля, рабочая инсталляция которого создается.
 Если эта переменная не определена, то команды 
\family typewriter 
make
\protected_separator 
create_wi
\family default 
 и 
\family typewriter 
make
\protected_separator 
update_wi
\family default 
 будут аварийно завершены.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_SCRIPTS_WI
\newline 

\family default 
\series default 
В этой переменной указывается разделенный пробелами список файлов (скриптов),
 которые следует переписать в каталог 
\family typewriter 
bin/
\family default 
 рабочей инсталляции, но не следует переписывать при выполнении команды
 
\family typewriter 
make
\protected_separator 
install
\family default 
.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEPEND_ON_EXACT
\newline 

\family default 
\series default 
Если эта переменная определена, то в файл 
\family typewriter 
depend.cvslvk
\family default 
 создаваемой рабочей инсталляции добавляется полные имена использованных
 при сборке каталога рабочих инсталляций модулей, имена которых перечислены
 в этой переменной.
 Это можно использовать в случае, когда модуль может быть собран с использование
м различных рабочими инсталляциями другого модуля, но создаваемая инсталляция
 должна зависеть от именно той рабочей инсталляции другого модуля, с которой
 собиралась.
 
\newline 
В будущих версиях системы cvslvk механизм передачи параметров между рабочими
 инсталляциями будет расширен.
\layout Standard

Порядок действий при создании рабочей инсталляции следующий:
\layout Itemize

проверяется наличие рабочей инсталляции; если рабочая инсталляция уже есть,
 то команда 
\family typewriter 
make
\protected_separator 
create_wi
\family default 
 аварийно завершится, а команда 
\family typewriter 
make
\protected_separator 
update_wi
\family default 
 сделает попытку удалить имеющуюся рабочую инсталляцию;
\layout Itemize

устанавливается переменная 
\family typewriter 
CL_PREFIX
\family default 
,
\layout Itemize

вызывается операция сборки каталога (с явно установленной переменной 
\family typewriter 
CL_PREFIX
\family default 
 -- это можно использовать если в собираемом модуле что-то зависит от пути
 инсталляции),
\layout Itemize

устанавливается переменная 
\family typewriter 
CL_INSTALL_WI
\family default 
 и вызывается команда 
\family typewriter 
make
\protected_separator 
install
\family default 
.
\layout Standard

Рабочая инсталляция готова к использованию немедленно после успешного завершения
 команды 
\family typewriter 
make
\protected_separator 
create_wi
\family default 
 или 
\family typewriter 
make
\protected_separator 
update_wi
\family default 
.
\layout Subsubsection

Создание рабочей инсталляции вручную
\layout Standard

Для создания рабочей инсталляции вручную следует создать в каталоге 
\family typewriter 
$(CL_DIR)/
\family default 
 подкаталог с соответствующем именем (
\family typewriter 
<
\family default 
имя-модуля
\family typewriter 
>_<
\family default 
параметры
\family typewriter 
>/
\family default 
) и поместить туда необходимые файлы, в т.ч.
 файлы 
\family typewriter 
rules.cvslvk
\family default 
 и/или 
\family typewriter 
depend.cvslvk
\family default 
.
 Первым параметром рабочей инсталляции 
\emph on 
обязательно
\emph toggle 
 должна быть архитектура (
\family typewriter 
sparc
\family default 
 или 
\family typewriter 
x86
\family default 
), а вторым -- операционная система (
\family typewriter 
solaris
\family default 
 или 
\family typewriter 
linux
\family default 
).
 При невыполнении этого условия система cvslvk не будет использовать инсталляцию
 во время сборки каталога.
\layout Standard

После ручного создания рабочей инсталляции необходимо выполнить команду
 
\family typewriter 
cvslvk
\protected_separator 
make_rules
\family default 
.
 При этом рабочая инсталляция будет зарегистрирована в системе и станет
 доступной в последующих операциях сборки каталогов.
\layout Standard

Для ускорения своей работы система cvslvk генерирует включаемый 
\family typewriter 
Makefile
\family default 
, который включает файлы 
\family typewriter 
rules.cvslvk
\family default 
 выбранных рабочих инсталляций, и кэширует результаты удовлетворения запросов
 на использование модулей.
 Каждое изменение в рабочих инсталляциях может сделать кэшированную информацию
 неверной и требует ее пересоздание.
 Именно этим и занимается команда 
\family typewriter 
cvslvk
\protected_separator 
make_rules
\family default 
.
 При изменениях в рабочих инсталляциях, осуществляемых самой системой, команда
 
\family typewriter 
cvslvk
\protected_separator 
make_rules
\family default 
 выполняется автоматически.
 При ручных изменениях эту команду следует выполнять явно.
 
\emph on 
Если в рабочих инсталляциях были сделаны изменения, а команда не была выполнена,
 то система может работать неверно.
\layout Standard

Если рабочая инсталляция была собрана и/или изменена вручную и ее потеря
 нежелательна, то рекомендуется создать в рабочей инсталляции файл с именем
 
\family typewriter 
NOREMOVE
\family default 
.
 В этом случае удаление этой рабочей инсталляции средствами системы cvslvk
 будет заблокировано.
\layout Standard

В текущей версии системы cvslvk инсталляции псевдомодулей можно создавать
 
\emph on 
только вручную
\emph toggle 
.
\layout Subsubsection

Написание файла 
\family typewriter 
rules.cvslvk
\layout Standard

Вне зависимости от способа создания рабочей инсталляции, необходимо определить
 семантику ее использования, т.е.
 написать файл 
\family typewriter 
rules.cvslvk
\family default 
.
 Причем писать его следует таким образом, чтобы максимально упростить использова
ние модуля и свести возможные ошибки к минимуму.
 В идеале файл 
\family typewriter 
rules.cvslvk
\family default 
 должен быть написан так, чтобы для использования модуля было достаточно
 упомянуть его имя в переменной 
\family typewriter 
CL_USE_MODULES
\family default 
.
 В крайнем случае можно потребовать определение нескольких переменных, управляющ
их использование модуля, при этом в файле 
\family typewriter 
rules.cvslvk 
\family default 
рекомендуется контролировать корректное определение этих переменных.
 Устанавливать более сложные условия использования модуля не рекомандуется.
\layout Standard

При определении в файле 
\family typewriter 
rules.cvslvk
\family default 
 внутренних переменных рекомендуется указывать ключевое слово 
\family typewriter 
override
\family default 
, чтобы исключить ошибки при определении этих же переменных в других модулях,
 в 
\family typewriter 
Makefile
\family default 
-е или в командной строке 
\family typewriter 
make
\family default 
.
 
\layout Standard

При изменении 
\family typewriter 
DEFINES
\family default 
, 
\family typewriter 
INCLUDES
\family default 
, 
\family typewriter 
LDFLAGS
\family default 
, флагов компилятора рекомендуется использовать конструкцию 
\family typewriter 
override
\protected_separator 
<
\family default 
имя
\family typewriter 
>
\protected_separator 
+=
\protected_separator 
<
\family default 
значение
\family typewriter 
>
\family default 
, чтобы флаги добавлялись даже если пользователь определил соответствующие
 переменные в командной строке.
 Ни в коем случае нельзя использовать присваивание в эти переменные, следует
 использовать только добавление -- иначе можно нарушить работоспособность
 других модулей, которые изменяют те же переменные.
\layout Standard

Для обеспечения простоты использования модуля в системе cvslvk определено
 несколько переменных и команд.
 В случае, если их недостаточно, обычно можно написать требуемое действие
 непосредственно на языке 
\family typewriter 
GNU
\protected_separator 
Makefile
\family default 
-а -- этот язык достаточно богат.
\layout Standard

Эти же переменные и команды в принципе можно использовать в 
\family typewriter 
Makefile
\family default 
-е в рабочем каталоге.
 Только определять переменные при этом следует выше включения $(CL_DIR)/Makefile.
cvslvk, а правила -- ниже включения.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_OBJECTS_NU
\newline 

\family default 
\series default 
Содержит список дополнительных объектных файлов, которые следует включить
 при сборке исполняемого файла или библиотеки.
\begin_deeper 
\layout Standard

По умолчанию список объектных файлов определяется из переменной 
\family typewriter 
SOURCES
\family default 
 при помощи удаления путей, добавления пути до каталога сборки и замены
 текста от последней точки до конца на 
\family typewriter 
.o
\family default 
.
 Если этого по какой-либо причине недостаточно, то дополнительные объектные
 файлы можно передать через переменную 
\family typewriter 
CL_OBJECTS_NU
\family default 
.
 Если файлы будут браться не из рабочего каталога (а, например, из каталога
 сборки), то следует указывать пути относительно рабочего каталога.
\layout Standard

В системе cvslvk определены шаблонные правила для сборки объектных файлов
 из Си- и Си++-файлов, находящихся в текущем каталоге или в каталоге сборки.
 Си-файлы определены как имеющие имя с суффиксом 
\family typewriter 
.c
\family default 
, Си++-файлы -- с суффиксом 
\family typewriter 
.cpp
\family default 
, а в рабочем каталоге -- еще с суффиксами 
\family typewriter 
.cc
\family default 
 или 
\family typewriter 
.С
\family default 
.
 В связи с этим для подключения к исполняемому файлу некоторых генерируемых
 Си- или Си++-файлов достаточно написать правила для их генерации, кладущие
 результат в каталог сборки, и добавить соответствующие объектные файлы
 в переменную 
\family typewriter 
CL_OBJECTS_NU
\family default 
.
\layout Standard

Например, библиотека 
\family typewriter 
Qt
\family default 
 требует подключения к исполняемому файлу дополнительных объектных файлов,
 сгенерированных на основе некоторых include-файлов.
 Добиться этого можно следующей конструкцией в файле 
\family typewriter 
rules.cvslvk
\family default 
 (предполагается, что в переменной 
\family typewriter 
MOC_HEADERS
\family default 
 перечислены include-файлы, требующие препроцессирования при помощи программы
 
\family typewriter 
moc
\family default 
):
\layout LyX-Code

$(CL_BD)/%.moc.cpp : %.h
\layout LyX-Code


\protected_separator 
 
\protected_separator 
 
\protected_separator 
 
\protected_separator 
 moc <$ -o $@
\layout LyX-Code

override CL_OBJECTS_NU += $(MOC_HEADERS:%.h=$(CL_BD)/%.moc.cpp)
\end_deeper 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEPS_NU
\newline 

\family default 
\series default 
Содержит список дополнительных файлов зависимостей.
\begin_deeper 
\layout Standard

Каждому файлу, для которого следует вычислять зависимости (обычно каждому
 исходному файлу), соответствует файл зависимостей.
 Файл зависимостей включается в 
\family typewriter 
Makefile
\family default 
 и задает зависимости одного исходного файла от других файлов.
 Файлы зависимостей вычисляются автоматически и кладутся в подкаталог сборки;
 их имена получаются из соответствующих имен исходных файлов при помощи
 добавления суффикса 
\family typewriter 
.deps
\family default 
.
\layout Standard

По умолчанию список требуемых файлов зависимостей получается из переменной
 
\family typewriter 
SOURCES
\family default 
.
 Однако, если некоторые файлы генерируются, то для вычисления их зависимостей
 следует добавить соответствующие имена в переменную 
\family typewriter 
CL_DEPS_NU
\family default 
.
\layout Standard

В рассмотренном выше примере для вычисления зависимостей файлов, генерируемых
 программой moc, можно написать
\layout LyX-Code

override CL_DEPS_NU += $(MOC_HEADERS:%.h=$(CL_BD)/%.moc.cpp.deps)
\layout Standard

В систему cvslvk встроены шаблонные правила для создания .deps-файлов из
 файлов, расположенных в рабочем каталоге и в каталоге сборки.
 При этом используется Си-препроцессор с ключем 
\family typewriter 
-MM
\family default 
.
 При использовании компилятора 
\family typewriter 
gcc
\family default 
 (
\family typewriter 
CL_COMP
\family default 
=
\family typewriter 
gcc
\family default 
) Си-препроцессору передаются все неявные макросы, которые ему передаются
 при компиляции.
 Для компиляторов Sun (
\family typewriter 
CL_COMP
\family default 
=
\family typewriter 
suncc
\family default 
) передача неявных макросов в данной версии системы cvslvk не реализована.
\layout Standard

В случае, если файл, по которому надо вычислять зависимости, находится где-либо
 кроме рабочего каталога и каталога сборки, то необходимо написать шаблонное
 правило для вычисления файлов зависимостей.
 Команда, требуемая для вычисления зависимостей, доступна через 
\series bold 
переменную 
\family typewriter 
CL_DEPEND_COMMAND
\family default 
\series default 
.
\begin_float footnote 
\end_deeper 
\layout Standard

На самом деле эта переменная определяется позже включения файлов 
\family typewriter 
rules.cvslvk
\family default 
.
 Тут используется механизм поздней подстановки.
\end_float 
 Таким образом, например, для вычисления зависимостей файлов, лежащих в
 каталоге 
\family typewriter 
$(PACKAGEDIR)
\family default 
, следует написать в файле 
\family typewriter 
rules.cvslvk
\family default 
 шаблонное правило
\begin_deeper 
\layout LyX-Code

$(CL_BD)/%.deps: $(PACKAGEDIR)/%
\layout LyX-Code


\protected_separator 
 
\protected_separator 
 
\protected_separator 
 
\protected_separator 
 $(CL_DEPEND_COMMAND)
\end_deeper 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_PRE_DEPEND
\newline 

\family default 
\series default 
Содержит список файлов (или целей 
\family typewriter 
make
\family default 
), которые требуется создать перед вычислением зависимостей.
\begin_deeper 
\layout Standard

В случаях, когда include-файлы создаются, зависимости не могут быть корректно
 вычислены до их создания.
 Более того, текущая версия системы cvslvk не может всегда автоматически
 отловить эту ситуацию, т.к.
 файлы зависимостей могут быть еще не созданы.
 Для корректной обработки этой ситуации введена переменная 
\family typewriter 
CL_PRE_DEPEND
\family default 
.
 
\layout Standard

Например, средство генерации парсера по грамматике 
\family typewriter 
yacc
\family default 
 (или его аналог 
\family typewriter 
bison
\family default 
) создает кроме собственно кода парсера 
\family typewriter 
y.tab.c
\family default 
 еще и include-файл 
\family typewriter 
y.tab.h
\family default 
.
 Для корректной обработки зависисмостей следует добавить 
\family typewriter 
$(CL_BD)/y.tab.c.deps
\family default 
 в переменную 
\family typewriter 
CL_DEPS_NU
\family default 
, и зависимости для файла 
\family typewriter 
y.tab.c
\family default 
 будут своевременно вычислены; при этом будет обнаружено отсутствие или
 устаревание файла 
\family typewriter 
y.tab.c
\family default 
 и при необходимости он будет (пере)создан.
 Однако, порядок вычисления зависимостей не определен, и, возможно, система
 попытается вычислить зависимости для какого-нибудь другого файла раньше.
 Если этот файл включает 
\family typewriter 
y.tab.h
\family default 
, то произойдет ошибка при сборке зависимостей (т.к.
 файла 
\family typewriter 
y.tab.h
\family default 
 еще не будет), и сборка каталога будет аварийно остановлена.
 
\layout Standard

Чтобы описанная ситуация не произошла, следует включить файл 
\family typewriter 
y.tab.h
\family default 
 в список 
\family typewriter 
CL_PRE_DEPEND
\family default 
.
\end_deeper 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_DEPEND_COMMAND
\family default 
\series default 
 
\series bold 

\newline 
Переменная: 
\family typewriter 
CL_C_COMPILE_COMMAND
\family default 

\newline 
Переменная: 
\family typewriter 
CL_CPP_COMPILE_COMMAND
\family default 
\series default 
 
\begin_deeper 
\layout Standard

Эти переменные содержат соответственно команды вычичления зависимости одного
 файла, компиляции одного Си-файла и компиляции одного Си++-файла.
 Используются эти переменные тогда, когда по какой-либо причине не срабатывают
 встроенные в систему cvslvk шаблонные правила, например когда исходные
 файлы расположены вне рабочего каталога и каталога сборки.
 Эти переменные предназначены для написания шаблонных правил следующего
 вида:
\layout LyX-Code

$(CL_BD)/%.o: $(MYDIR)/%.c
\layout LyX-Code


\protected_separator 
 
\protected_separator 
 
\protected_separator 
 
\protected_separator 
 $(CL_C_COMPILE_COMMAND)
\end_deeper 
\layout Itemize

Имеется команда для аварийной остановки сборки каталога с выдачей сообщения.
 Она выглядит следующим образом:
\begin_deeper 
\layout LyX-Code

override CL_TMP := $(shell $(CL_HELPER) error <сообщение>)
\layout Standard

Суть этой конструкции -- безусловный вызов 
\family typewriter 
shell
\family default 
-команды 
\family typewriter 
$(CL_HELPER)
\protected_separator 
error
\family default 
, параметром которой является сообщение об ошибки.
 Безусловность вызова обеспечивается применением конструкций 
\family typewriter 
override
\family default 
 и 
\family typewriter 
:=
\family default 
.
\layout Standard

Сообщение не должно содержать скобок и управляющих символов 
\family typewriter 
shell
\family default 
-а.
\layout Standard

Эту команду рекомендуется использовать всегда, когда обнаружены некорректные
 ситуации, например неверные значения переменных.
\end_deeper 
\layout Itemize

Имеются дополнительные возможности проверки корректной установки переменных.
 См.
 раздел 
\begin_inset LatexCommand \ref{sec: env}

\end_inset 

.
\layout Itemize

Имеется возможность управления порядком подключения библиотек.
 См.
 раздел 
\begin_inset LatexCommand \ref{sec: liborder}

\end_inset 

.
\layout Itemize

Для использования модуля после сборки каталога в файле rules.cvslvk может
 быть определена 
\series bold 
переменная 
\family typewriter 
CL_SYMLINKS
\family default 
\series default 
.
 В ней указываются полные пути до файлов (например, в рабочей инсталляции),
 символьные ссылки на которые следует создать в рабочем каталоге.
\layout Subsubsection

Удаление рабочих инсталляций
\layout Standard

Для удаления рабочей инсталляции служит команда 
\family typewriter 
cvslvk
\protected_separator 
remove_wi
\family default 
.
 Параметры этой комады -- полные имена рабочих инсталляций, подлежащих удалению.
\layout Standard

Если в рабочей инсталляции (в ее корневом каталоге) имеется файл с именем
 
\family typewriter 
NOREMOVE
\family default 
, то удаление этой рабочей инсталляции командой будет 
\family typewriter 
cvslvk
\protected_separator 
remove_wi
\family default 
 заблокировано.
\layout Standard

Рабочие инсталляции можно удалять и вручную, удалив соответствующий подкаталог
 в каталоге 
\family typewriter 
$(CL_DIR)/
\family default 
.
 Однако после этого обязательно следует выполнить команду 
\family typewriter 
cvslvk
\protected_separator 
make_rules
\family default 
 для удаления рабочей инсталляции из списков.
 При удалении рабочих инсталляций командой 
\family typewriter 
cvslvk
\protected_separator 
remove_wi
\family default 
 списки обновляются автоматически.
\layout Subsection

Работа с библиотеками
\layout Standard

Для сборки библиотек в системе cvslvk имеется специальный режим, включаемый
 при помощи определения 
\series bold 
переменной 
\family typewriter 
LIBRARY
\family default 
\series default 
.
 В этом режиме из исходных файлов, указанных в переменной 
\family typewriter 
SOURCES
\family default 
, и, возможно, дополнительных объектных файлов, указанных в переменной 
\family typewriter 
CL_OBJECTS_NU
\family default 
, собирается библиотека.
\layout Subsubsection

Разделяемые и статические библиотеки
\layout Standard

Библиотеки в UNIX-е могут быть статические и разделяемые.
 
\layout Standard

Статические библиотеки представляют из себя просто набор объектных файлов,
 которые подключаются к испольняемому файлу на этапе компоновки, если в
 них определены функции или глобальные переменные, к которым имеются обращения
 в ранее подключенных объектных файлах.
 Соответственно, код из этих объектных файлов физически копируется в каждый
 исполняемый файл, скомпонованный с библиотекой, приводя к перерасходу дискового
 пространства.
\layout Standard

Разделяемые библиотеки представляют из себя структуры, загружаемые в память
 при запуске программы или даже позже.
 Современные версии ОС UNIX обеспечивают прозрачное использование разделяемых
 библиотек -- любые функции и/или данные могут быть помещены в разделяемую
 библиотеку 
\emph on 
без каких-либо дополнительных усилий программиста
\emph toggle 
, тем самым экономя место на диске и позволяя исправлять в них ошибки 
\emph on 
без перетрансляции использующих их программ
\emph toggle 
.
\layout Standard

Единственное достоинство статических библиотек заключается в том, что скомпонова
нные с ними исполняемые файлы 
\begin_inset Quotes eld
\end_inset 

самодостаточны
\begin_inset Quotes erd
\end_inset 

 -- для их запуска не требуется каких-либо внешних по отношениюк ним объектов
 и/или настроек.
 Если же файл скомпонован с разделяемой библиотекой, то необходимо обеспечить,
 чтобы библиотека с указанным именем была 
\emph on 
найдена
\emph toggle 
 при каждом записке исполняемого файла, и чтобы она была при этом 
\emph on 
двоично совместима
\emph toggle 
 с использованной при компоновке библиотекой.
 При этом вовсе не обязательно использовать в точности ту же библиотеку,
 что использовалась при компоновке.
 Например, после компоновки в библиотеки могла быть исправлена ошибка, и
 после этого программа немедленно начнет использовать исправленную версию
 библиотеки.
\layout Standard

Система cvslvk скрывает практически все технические детали, связанные с
 использованием разделяемых библиотек.
 По умолчанию все создаваемые библиотеки разделяемые.
 Единственное что требуется от пользользователей -- следить за сохранением
 двоичной совместимости и при нарушении таковой изменять 
\emph on 
имя класса совместимости
\emph toggle 
 библиотеки.
\layout Subsubsection

Три имени разделяемой библиотеки в ОС UNIX
\layout Standard

В общем случае разделяемая библиотека имеет три имени (хотя некоторые из
 них могут совпадать) -- полное имя библиотеки, 
\emph on 
имя класса совместимости
\emph toggle 
 и 
\emph on 
имя для компоновщика
\emph toggle 
.
 Обычно (хотя и не обязательно) эти имена различаются только уточнениями
 номеров версий.
 Например, полное имя библиотеки может быть 
\family typewriter 
libqt.so.1.44
\family default 
, имя класса совместимости -- 
\family typewriter 
libqt.so.1
\family default 
, имя для компоновщика -- 
\family typewriter 
libqt.so
\family default 
.
 
\layout Standard

Смысл этих имен заключается в следующем.
 Файл с именем библиотеки содержит конкретную версию библиотеки.
 Имя класса совместимости прописывается в исполняемый файл -- по этому имени
 библиотека будет загружаться при записке использующего ее исполняемого
 файла.
 Файл с именем класса совместимости обычно представляет из себя символьную
 ссылку на библиотеку конкретной версии.
 Наконец, имя для комполовщика должно быть всегда обинаковым -- 
\family typewriter 
lib<
\family default 
имя
\family typewriter 
>.so
\family default 
.
 Файл с таким именем ищется по ключу 
\family typewriter 
-l<
\family default 
имя
\family typewriter 
>
\family default 
 компоновщика.Обычно это также бывает символьная ссылка.
\layout Standard

При исправлении ошибки изменяется можно истинное имя файла, но не менять
 имя класса совместимости.
 Соответственно исполняемые файлы, скомпонованные ранее, будут по-прежнему
 находить требуемую библиотеку.
 При помощи переключения символьной ссылки с одного варианта библиотеки
 на другой можно запускать файл с той или другой версией библиотеки.
 В принципе, полное имя библиотеки может совпадать с именем класса совместимости.
\layout Standard

Если изменение в библиотеке таково, что потеряна двоичная совместимость
 (например, изменен прототип какой-либо функции), то использовать старые
 исполняемые файлы с новой библиотекой невозможно.
 Тогда следует изменить имя класса совместимости.
 Теперь старые исполняемые файлы могут продолжать использовать старую библиотеку
, а новые будут использовать новую.
 Для обеспечения последнего следует переключить ссылку с именем библиотеки
 для компоновщика на файл с новой версией библиотеки.
\layout Subsubsection

Поиск разделяемых библиотек при запуске исполняемого файла
\layout Standard

В процессе запуска исполняемого файла OC UNIX должна найти все используемые
 этим файлом разделяемые библиотеки.
 Для этого используются следующие механизмы.
\layout Itemize

Библиотека может быть в одном из каталогов, в которых поиск производится
 по умолчанию.
 Список этих каталогов может быть фиксирован или же настраиваться системным
 администратором.
 В любом случае для того, чтобы библиотеки были найдены этим способом, требуется
 вмешательство системного администратора.
\layout Itemize

Библиотека может быть в одном из каталогов, перечисленных у пользователя
 в переменной среды 
\family typewriter 
LD_LIBRARY_PATH
\family default 
.
 При помощи этой переменной всегда можно добиться, чтобы разделяемые библиотеки
 были корректно найдены, однако это требует персональной установки переменной
 
\family typewriter 
LD_LIBRARY_PATH
\family default 
 у каждого пользователя, что неудобно.
\layout Itemize

Пути для поиска разделяемых библиотек могут быть прописаны непосредственно
 в исполняемый файл (механизм 
\family typewriter 
rpath
\family default 
).
 В этом случае никаких дополнительных установок ни у пользователя, ни у
 системного администратора не требуется.
 Однако, перемещение разделяемых библиотек из одного места в другое потребует
 перекомпоновки исполняемого файла.
\layout Standard

В системе cvslvk в основном используется третий метод.
 Все пути, указанные в ключах 
\family typewriter 
-L
\family default 
 компоновщика, система cvslvk автоматически прописывается в исполняемый
 файл (при помощи соответствующей обработки переменной 
\family typewriter 
LDFLAGS
\family default 
).
 В большинстве случаев это обеспечит корректную работу.
\layout Standard

Команда 
\family typewriter 
ldd
\family default 
 позволяет определить, откуда берутся разделяемые библиотеки при запуске
 исполняемого файла.
\layout Subsubsection

Сборка библиотек в системе cvslvk
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
LIBRARY
\newline 

\family default 
\series default 
Если определена эта переменная, то в текущем каталоге собирается библиотека.
 Переменная 
\family typewriter 
LIBRARY
\family default 
 содержит имя библиотеки, которое будет использоваться в ключе 
\family typewriter 
-l
\family default 
 компоновщика при подключении этой библиотеки
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_LTYPE
\family default 
\series default 

\newline 
Возможные значения: shared, static
\newline 
Значение по умолчанию: shared
\newline 
Определяет тип собираемой библиотеки: разделяемая или статическая.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_LIBRARY_VERSION
\newline 

\family default 
Переменная: 
\family typewriter 
CL_LIBRARY_REVISION
\newline 

\family default 
\series default 
Эти переменные используются при сборке разделяемых библиотек (
\family typewriter 
CL_LTYPE
\family default 
=
\family typewriter 
shared
\family default 
) для установки трех имен разделяемой библиотеки.
 Имена устанавливаются следующим образом:
\begin_deeper 
\layout Itemize

имя для компоновщика -- всегда 
\family typewriter 
lib$(LIBRARY).so
\family default 
,
\layout Itemize

имя класса совместимости -- 
\family typewriter 
lib$(LIBRARY).so.$(CL_LIBRARY_VERSION)
\family default 
, если определена переменная 
\family typewriter 
CL_LIBRARY_VERSION
\family default 
, иначе 
\family typewriter 
lib$(LIBRARY).so
\family default 
,
\layout Itemize

полное имя библоитеки -- 
\family typewriter 
lib$(LIBRARY).so.$(CL_LIBRARY_VERSION).$(CL_LIBRARY_REVIRSION)
\family default 
, если определены обе переменные 
\family typewriter 
CL_LIBRARY_VERSION
\family default 
 и 
\family typewriter 
CL_LIBRARY_REVIRSION
\family default 
, иначе 
\family typewriter 
lib$(LIBRARY).so.$(CL_LIBRARY_VERSION)
\family default 
, если определена переменная 
\family typewriter 
CL_LIBRARY_VERSION
\family default 
, иначе 
\family typewriter 
lib$(LIBRARY).so
\family default 
.
\layout Standard

Если собирается статическая библиотека (
\family typewriter 
CL_LTYPE
\family default 
=
\family typewriter 
static
\family default 
), то ее имя всегда будет 
\family typewriter 
lib$(LIBRARY).a
\family default 
.
\end_deeper 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
EXPORT_INCLUDES
\newline 

\family default 
\series default 
Содержит разделенный пробелами список файлов (скорее всего include-файлов)
 для комирования в подкаталог 
\family typewriter 
include/
\family default 
 каталога инсталляции.
\layout Standard

При сборке библиотеки значение 
\family typewriter 
CL_LTYPE
\family default 
 всегда оказывается среди параметров сборки, таким образом объектные файлы
 для статической и разделяемой версий библиотеки разделены.
 
\layout Standard

Сборка разделяемых библиотек компиляторами Sun в текущей версии системы
 cvslvk не поддерживается.
 Имеются подозрения, что компиляторы фирмы Sun из пакета 
\family typewriter 
SUNWspro
\protected_separator 
4
\family default 
 (как минимум с языка Си++) создают некорректные разделяемые библиотеки
 и/или исполняемые файлы, использующие разделяемые библиотеки.
 При работе с компиляторами Sun значение переменной 
\family typewriter 
CL_LTYPE
\family default 
 по умолчанию -- 
\family typewriter 
static
\family default 
.
\layout Standard

Флаг 
\family typewriter 
-fPIC
\family default 
, необходимый компилятору 
\family typewriter 
gcc
\family default 
 для сборки объектных файлов для разделяемой библиотеки, подключается автоматиче
ски.
\layout Standard

Разделяемые библиотеки создаются из объектных файлов при помощи команды
 
\family typewriter 
gcc
\protected_separator 
-shared
\family default 
.
 Значение 
\family typewriter 
LDFLAGS
\family default 
 этой команде 
\emph on 
не передается
\emph toggle 
.
\begin_float footnote 
\layout Standard

Это, в частности, означает невозможность прописывать в создаваемые разделяемые
 библиотеки зависимости от других разделяемых библиотек.
 Такой межанизм планируется в будущих версиях системы
\end_float 
\layout Standard

При использовании компилятора Sun Си++ статические библиотеки создаются
 командой 
\family typewriter 
CC
\protected_separator 
-xar
\family default 
.
 Эта команда может работать долго (сравнимо с компиляцией всех объектных
 файлов), но зато автоматически будут созданы все упомянуиые в библиотеке
 экземпляры 
\family typewriter 
template
\family default 
-ов.
\layout Standard

В остальных случаях статические библиотеки создаются командой 
\family typewriter 
ar
\protected_separator 
cr
\family default 
.
\layout Subsubsection

Использоваение библиотек
\layout Standard

В системе cvslvk может быть три способа использования библиотек программами.
\layout Standard

Первый способ -- использовать библиотеку внешними по отношению к системе
 cvslvk средствами, т.е.
 явно указывая соответствующие флаги в 
\family typewriter 
Makefile
\family default 
-е в переменных 
\family typewriter 
INCLUDES
\family default 
 и 
\family typewriter 
LDFLAGS
\family default 
.
 Этот способ можно использовать для подключения библиотеки, установленной
 помимо системы cvslvk, если соответствующий псевдомодуль не создан.
\layout Standard

Второй способ -- механизм модулей и рабочих инсталляций.
 Из библиотеки создается модуль, для ее использования устанавливается соответств
ующее требование в переменной 
\family typewriter 
CL_USE_MODULES
\family default 
, а все необходимые установки переменных поступают автоматически из файла
 
\family typewriter 
rules.cvslvk
\family default 
 рабочей инсталляции библиотеки.
 Это рекомендуемый способ подключения библиотек, собираемых при помощи системы
 cvslvk и используемых более чем одним проектом.
\layout Standard

Третий способ -- механизм 
\emph on 
внутренних библиотек
\emph toggle 
.
 Если библиотека используется только в одном проекте, то делать из нее отдельный
 модуль не имеет смысла.
 Вместо этого, можно собрать библиотеку в подкаталоге и подключить локально.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_INTERNAL_LIBRARY
\family default 
\series default 

\newline 
Эта переменная эквивалентна 
\family typewriter 
LIBRARY
\family default 
 с единственным исключением: при инсталляции статическая библиотека не инсталлир
уетя, а у разделяемой не инсталлируется имя для компоновщика.
 В итоге после инсталляции невозможна компоновка с библиотекой (но возможен
 запуск скомпонованных с ней исполняемых файлов).
\begin_deeper 
\layout Standard

В каталогах, где собирается 
\begin_inset Quotes eld
\end_inset 

локальная
\begin_inset Quotes erd
\end_inset 

 библиотека, следует определять переменную 
\family typewriter 
INTERNAL_LIBRARY
\family default 
 вместо переменной 
\family typewriter 
LIBRARY
\family default 
, и не определять переменную 
\family typewriter 
EXPORT_INCLUDES
\family default 
.
\end_deeper 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_USE_IL
\family default 
\series default 

\newline 
Эта переменная используется при сборке исполняемого файла и содержит список
 каталогов, в которых собираются 
\begin_inset Quotes eld
\end_inset 

локальные
\begin_inset Quotes erd
\end_inset 

 библиотеки, с которыми следует компоновать исполняемый файл.
\begin_deeper 
\layout Standard

В текущей версии системы cvslvk имеются следующее ограничение: имя каждого
 каталога, перечисленного в переменной 
\family typewriter 
CL_USE_IL
\family default 
, должно совпадать с именем библиотеки, собираемой в этом каталоге.
 
\layout Standard

Если определена переменная 
\family typewriter 
CL_USE_IL
\family default 
, то выполняются следующие действия:
\layout Itemize

в переменную 
\family typewriter 
INCLUDES
\family default 
 добавляются пути в каталоги, перечисленные в переменной 
\family typewriter 
CL_USE_IL
\family default 
,
\layout Itemize

в переменную 
\family typewriter 
LDFLAGS
\family default 
 добавляются соответствующие ключи 
\family typewriter 
-L
\family default 
 и 
\family typewriter 
-l
\family default 
,
\layout Itemize

перед сборкой текущего каталога будет выполнена сборка каталогов, перечисленных
 в переменной 
\family typewriter 
CL_USE_IL
\family default 
,
\layout Itemize

в процессе сборки каталога в исполняемый файл при компоновки прописываются
 пути до разделяемых библиотек, указанные в переменной 
\family typewriter 
CL_IL_LIBS
\family default 
 (и дополненные до глобальных путей); в процессе инсталляции производится
 перекомпоновка и вместо путей из 
\family typewriter 
CL_IL_LIBS
\family default 
 прописывается единственный путь 
\family typewriter 
$(CL_PREFIX)/lib
\family default 
.
 Эти действия соответствуют понятию 
\emph on 
внутренний библиотеки модуля
\emph toggle 
 (отсюда и имя переменной 
\family typewriter 
INTERNAL_LIBRARY
\family default 
) -- некоторая библиотека используется несколькими программами и только
 ими, эти программы и библиотека объединяются в один модуль.
\layout Standard

Автоматической инсталляции каталогов, перечисленных в переменной 
\family typewriter 
CL_USE_IL
\family default 
, 
\emph on 
не производится
\emph toggle 
 -- чтобы избежать многократных инсталляций этих каталогов при использовании
 библиотеки несколькомо программами.
 Автоматической очистки тоже не производится -- чтобы не удалять библиотеку,
 используемую несколькими программами, при очистке в каталоге одной из этих
 программ.
\layout Standard

Рекомендуется следующая организация модуля, состоящего из внутренних библиотек
 и программ.
 На глобальном уровне имеются подкаталоги для каждой библиотеки и программы
 и 
\family typewriter 
Makefile
\family default 
, определяющий только переменную 
\family typewriter 
SUBDIRS
\family default 
 (и, возможно, переменную 
\family typewriter 
CL_MODULE
\family default 
).
 В каталогах, соответствующих библиотекам, определяется переменная 
\family typewriter 
INTERNAL_LIBRARY
\family default 
.
 Наконец, в каталогах с программами определяется переменная 
\family typewriter 
CL_USE_IL
\family default 
.
\end_deeper 
\layout Standard


\emph on 
Замечание.
 Как показывает опыт, если библиотека что-либо использует, то использующие
 эту библиотеку программы должны использовать то же самое.
 Видимо, нужен какой-то механизм для наследования использования в этом случае.
 Такой механизм возможно будет реализован в следующих версиях системы cvslvk.
 В текущей версии приходится переносить информацию об использовании вручную.
 Однако, это не очень страшно, т.к.
 если это забыть, то возникнет ошибка при сборке, диагностируемая автоматически.
\layout Subsection

Дополнительные возможности
\layout Subsubsection

Проверка переменных среды
\begin_inset LatexCommand \label{sec: env}

\end_inset 


\layout Standard

Некоторые программы и/или модули можно корректно собирать и/или использовать
 только при корректной установке определенных переменных.
 В связи с этим в системе cvslvk имеется механизм проверки переменных.
 Можно просто проверить некоторую наличие некоторой переменной, или проверить,
 что переменная приняла одно из указанного набора значений.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_VARS
\newline 

\family default 
\series default 
В этой переменной указываются разделенные пробелами условия, которые трубуется
 проверить.
 Условия могут быть двух видов.
 Дла проверки наличия
\begin_float footnote 
\layout Standard

Строго говоря, непустоты
\end_float 
 переменной требуется просто указать ее имя.
 Для проверки того, что переменная приняла одно из указанных значений, условие
 записывается в виде 
\family typewriter 
<
\family default 
имя
\family typewriter 
>:<
\family default 
значение1
\family typewriter 
>|
\family default 
...
\family typewriter 
|<
\family default 
значениеN
\family typewriter 
>
\family default 
.
 В случае несоблюдения условия (переменная не определена или определена
 в пустую строку в первом случае, переменная не определена или ее значение
 не совпадает ни с одним из перечисленных во втором случае) команда 
\family typewriter 
make
\family default 
 будет аварийно завершена.
 
\begin_deeper 
\layout Standard

Примеры: 
\layout Itemize


\family typewriter 
override
\protected_separator 
CL_VARS
\protected_separator 
+=
\protected_separator 
QT_DIR
\family default 
 -- потребовать обязательное определение переменной 
\family typewriter 
QT_DIR
\family default 
,
\layout Itemize

override
\protected_separator 

\family typewriter 
CL_VARS
\protected_separator 
+=
\protected_separator 
MTTYPE:mtint|mtfloat|mtdouble
\family default 
 -- потребовать определение переменной 
\family typewriter 
MT_TYPE
\family default 
, причем в одно из значений mtint, mtfloat или mtdouble.
\layout Standard

Если корректная работа модуля зависит от определения переменных, то рекомендуетс
я в файле 
\family typewriter 
rules.cvslvk
\family default 
 добавлять соответствующие условия в переменную 
\family typewriter 
CL_VARS
\family default 
.
\end_deeper 
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_CHECK_VARS_COMMAND
\newline 

\family default 
\series default 
По умолчанию проверка условий, занесенных в переменную 
\family typewriter 
CL_VARS
\family default 
, производится сначала до включения файлов , а если в них были определены
 новые условия -- то еще раз после включения файлов 
\family typewriter 
rules.cvslvk
\family default 
.
 Если по какой-либо причине при несоблюдении условий необходимо немедленно
 прекратить дальнейшую работу, то это можно сделать при помощи комадны,
 хранимой в переменной 
\family typewriter 
CL_CHECK_VARS_COMMAND
\family default 
.
 Например:
\begin_deeper 
\layout LyX-Code

override CL_VARS += MYVAR:val1|val2
\layout LyX-Code

$(
\family typewriter 
CL_CHECK_VARS_COMMAND
\family default 
)
\layout LyX-Code

override CL_VARS :=
\end_deeper 
\layout Standard

Последняя строка служит для сброса переменной 
\family typewriter 
CL_VARS
\family default 
 с целью избежать лишнего вызова 
\family typewriter 
$(CL_CHECK_VARS_COMMAND)
\family default 
 после окончания чтения файлов 
\family typewriter 
rules.cvslvk
\family default 
.
 В принципе, это не обязательно, но желательно, т.к.
 команда 
\family typewriter 
$(CL_CHECK_VARS_COMMAND)
\family default 
 связана с лишним вызовом внешней программы проверки и потому работает сравнител
ьно медленно.
 По этой же причине если проверку можно отложить до окончания чтения файлов
 
\family typewriter 
rules.cvslvk
\family default 
, то 
\family typewriter 
$(CL_CHECK_VARS_COMMAND)
\family default 
 лучше вообще не использовать.
\layout Subsubsection

Управление порядком библиотек
\begin_inset LatexCommand \label{sec: liborder}

\end_inset 


\layout Standard

В некоторых случаях существенно, в каком порядке передаются компоновщику
 ключи 
\family typewriter 
-l
\family default 
.
 Например, если одна и та же функция определена более чем в одной библиотеке,
 то будет использована первая найденая.
 Или (только при использовании статических библиотек) если функции одной
 библиотеки вызывают функции другой, то первая должна подключаться раньше
 -- если раньше будет подключена вторая, то к моменту ее подключения ссылок
 на ее объектные файлы не будет и соответственно эти объектные файлы не
 будут подключены.
\layout Standard

В системе cvslvk ключи компоновщика могут добавляться из файлов 
\family typewriter 
rules.cvslvk
\family default 
, порядок подключения которых неопределен.
 Чтобы порядком библиотек все равно можно было управлять, имеется специальный
 механизм.
\layout Itemize


\series bold 
Переменная: 
\family typewriter 
CL_LIBORDER
\newline 

\family default 
\series default 
В этой переменной указываются пары библиотек, относительный порядок которых
 должен быть конкретным.
 Например:
\begin_deeper 
\layout LyX-Code

override CL_LIBORDER += -lwx,-lXm
\layout Standard

Это определение требует, чтобы в командной строке компоновщика ключ 
\family typewriter 
-lwx
\family default 
 был указан раньше ключа 
\family typewriter 
-lXm
\family default 
.
 
\layout Standard

В переменной CL_LIBORDER
\end_deeper 
\layout Subsubsection

Зависимость 
\family typewriter 
$(ALWAYS)
\layout Subsubsection

Блокировка вычисления зависимостей
\layout Section

Сообщения об ошибках
\layout Section

Техническое описание системы
\layout Section

Известные ошибки и недоработки
\layout Section

Описание стандартных псевдомодулей
\the_end
